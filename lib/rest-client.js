"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable:ban-types
const http_request_options_1 = require("./http-request-options");
const named_values_1 = require("./named-values");
require("reflect-metadata");
const util_1 = require("./util");
/**
 * Abstract base class for the REST clients.
 */
class RestClient {
    constructor(options) {
        /**
         * Request interceptor allowing to modifiy the collected request data before sending it.
         * Typical use is the insertion of an authorization token to the request headers.
         * Leave null if you don't want to use it.
         */
        this[_a] = null;
        this[util_1.SymbolHttpClient] = options.httpClient;
        this[util_1.SymbolRequestInterceptor] = options.requestInterceptor || null;
    }
    get $baseURL() {
        return this[util_1.SymbolBaseUrl]();
    }
    get $http() {
        return this[util_1.SymbolHttpClient];
    }
    $request(options) {
        return this[util_1.SymbolHttpClient].request(options);
    }
    /**
     * Returns the base of the REST API URL.
     */
    [(_a = util_1.SymbolRequestInterceptor, util_1.SymbolBaseUrl)]() {
        return getThisTypeMetadata("BASE_URL" /* BASE_URL */, this) || null;
    }
    /**
     * Returns the default HTTP headers attached to each request.
     */
    [util_1.SymbolDefaultHeaders]() {
        return getThisTypeMetadata("DEFAULT_HEADERS" /* DEFAULT_HEADERS */, this) || null;
    }
}
exports.RestClient = RestClient;
/**
 * Sets the default HTTP headers attached to each request to the REST API.
 * Intended to use as a decorator: @DefaultHeaders({'Header': 'value', 'Header2': 'value'}
 * @param headers   The headers in key-value pairs.
 */
function DefaultHeaders(headers) {
    return function (Target) {
        setClassMetadata("DEFAULT_HEADERS" /* DEFAULT_HEADERS */, headers, Target);
        return Target;
    };
}
exports.DefaultHeaders = DefaultHeaders;
/**
 * Sets the base URL of the REST API.
 * Intended to use as a decorator: @BaseUrl("http://...")
 * @param url   the base URL.
 */
function BaseUrl(url) {
    return function (Target) {
        setClassMetadata("BASE_URL" /* BASE_URL */, util_1.urlNormalize(url), Target);
        return Target;
    };
}
exports.BaseUrl = BaseUrl;
function getThisTypeMetadata(metadataKey, target) {
    return Reflect.getMetadata(metadataKey, Reflect.getPrototypeOf(target));
}
exports.getThisTypeMetadata = getThisTypeMetadata;
function getClassMetadata(metadataKey, target) {
    return Reflect.getMetadata(metadataKey, target.prototype);
}
exports.getClassMetadata = getClassMetadata;
function setClassMetadata(metadataKey, metadataValue, target) {
    Reflect.defineMetadata(metadataKey, metadataValue, target.prototype);
}
exports.setClassMetadata = setClassMetadata;
function getRestClientMethodMetadata(metadataKey, target, propertyKey) {
    return Reflect.getMetadata(metadataKey, target, propertyKey);
}
exports.getRestClientMethodMetadata = getRestClientMethodMetadata;
function setRestClientMethodMetadata(metadataKey, target, propertyKey, metadataValue) {
    return Reflect.defineMetadata(metadataKey, metadataValue, target, propertyKey);
}
exports.setRestClientMethodMetadata = setRestClientMethodMetadata;
function paramBuilder(paramName) {
    return function (key, defaultValue) {
        return function (target, propertyKey, parameterIndex) {
            //const metadataKey = `${String(propertyKey)}_${paramName}_parameters`;
            const paramObj = {
                key,
                parameterIndex,
                defaultValue,
            };
            let arr = getRestClientMethodMetadata(paramName, target, propertyKey);
            if (Array.isArray(arr)) {
                arr.push(paramObj);
            }
            else {
                arr = [paramObj];
            }
            setRestClientMethodMetadata(paramName, target, propertyKey, arr);
        };
    };
}
/**
 * Path variable of a method's URL, type: string.
 * @param key   path key to bind value.
 */
exports.Path = paramBuilder("Path" /* PARAM_PATH */);
/**
 * Query value of a method's URL, type: string.
 * @param key   query key to bind value.
 */
exports.Query = paramBuilder("Query" /* PARAM_QUERY */);
/**
 * Body of a REST method, type: key-value pair object.
 * Only one body per method!
 */
exports.Body = paramBuilder("Body" /* PARAM_BODY */)('Body');
/**
 * Custom header of a REST method, type: string.
 * @param key   header key to bind value.
 */
exports.Header = paramBuilder("Header" /* PARAM_HEADER */);
/**
 * Set custom headers for a REST method.
 * @param headersDef    custom headers in key-value pairs.
 */
function Headers(headersDef) {
    return function (_target, _propertyKey, descriptor) {
        // @ts-ignore
        descriptor.headers = headersDef;
        return descriptor;
    };
}
exports.Headers = Headers;
function methodBuilder(method) {
    return function (url) {
        return function (target, propertyKey, descriptor) {
            //const pPath = target[`${propertyKey}_Path_parameters`] as Parameter[];
            //const pQuery = target[`${propertyKey}_Query_parameters`] as Parameter[];
            //const pBody = target[`${propertyKey}_Body_parameters`] as Parameter[];
            //const pHeader = target[`${propertyKey}_Header_parameters`] as Parameter[];
            const pPath = getRestClientMethodMetadata("Path" /* PARAM_PATH */, target, propertyKey);
            const pQuery = getRestClientMethodMetadata("Query" /* PARAM_QUERY */, target, propertyKey);
            const pBody = getRestClientMethodMetadata("Body" /* PARAM_BODY */, target, propertyKey);
            const pHeader = getRestClientMethodMetadata("Header" /* PARAM_HEADER */, target, propertyKey);
            const oldFn = descriptor.value;
            setRestClientMethodMetadata("METHOD" /* METHOD */, target, propertyKey, method);
            descriptor.value = function (...args) {
                let body = null;
                if (pBody) {
                    body = JSON.stringify(args[pBody[0].parameterIndex]);
                }
                const self = this;
                let resUrl = url;
                if (pPath) {
                    for (const k in pPath) {
                        if (pPath.hasOwnProperty(k)) {
                            let value = args[pPath[k].parameterIndex];
                            if (typeof value === 'undefined' && typeof pPath[k].defaultValue !== 'undefined') {
                                let defaultValue = pPath[k].defaultValue;
                                if (typeof defaultValue === 'function') {
                                    value = defaultValue();
                                }
                                else {
                                    value = defaultValue;
                                }
                            }
                            resUrl = resUrl.replace('{' + pPath[k].key + '}', value);
                        }
                    }
                }
                const params = new named_values_1.NamedValues();
                if (pQuery) {
                    pQuery
                        .filter(p => args[p.parameterIndex])
                        .forEach(p => {
                        const key = p.key;
                        let value = args[p.parameterIndex];
                        if (value instanceof Object) {
                            value = JSON.stringify(value);
                        }
                        params.set(key, value);
                    });
                }
                const headers = new named_values_1.NamedValues(self[util_1.SymbolDefaultHeaders]());
                if (descriptor.headers) {
                    for (const k in descriptor.headers) {
                        if (descriptor.headers.hasOwnProperty(k)) {
                            // @ts-ignore
                            headers.set(k, descriptor.headers[k]);
                        }
                    }
                }
                if (pHeader) {
                    for (const k in pHeader) {
                        if (pHeader.hasOwnProperty(k)) {
                            headers.set(pHeader[k].key, args[pHeader[k].parameterIndex]);
                        }
                    }
                }
                const finalUrl = util_1.urlResolve(resUrl, self[util_1.SymbolBaseUrl]());
                let request = new http_request_options_1.HttpRequestOptions(finalUrl, method, body, headers, params);
                if (this[util_1.SymbolRequestInterceptor]) {
                    request = this[util_1.SymbolRequestInterceptor](request);
                }
                if (request instanceof http_request_options_1.HttpRequestOptions) {
                    // @ts-ignore
                    request = request.toValue();
                }
                const oldTransformResponse = request.transformResponse;
                let newTransformRespons = function (data) {
                    let ret = oldFn.call(self, data);
                    if (ret == null) {
                        return data;
                    }
                    return ret;
                };
                if (!Array.isArray(oldTransformResponse)) {
                    if (!oldTransformResponse) {
                        request.transformResponse = [];
                    }
                    else {
                        request.transformResponse = [oldTransformResponse];
                    }
                }
                request.transformResponse.push(newTransformRespons);
                //console.log(request);
                return self.$http.request(request);
            };
        };
    };
}
exports.methodBuilder = methodBuilder;
/**
 * GET method.
 * @param url   resource URL of the method
 */
exports.GET = methodBuilder("GET" /* METHOD_GET */);
/**
 * POST method.
 * @param url   resource URL of the method
 */
exports.POST = methodBuilder("POST" /* METHOD_POST */);
/**
 * PUT method.
 * @param url   resource URL of the method
 */
exports.PUT = methodBuilder("PUT" /* METHOD_PUT */);
/**
 * PATCH method.
 * @param url   resource URL of the method
 */
exports.PATCH = methodBuilder("PATCH" /* METHOD_PATCH */);
/**
 * DELETE method.
 * @param url   resource URL of the method
 */
exports.DELETE = methodBuilder("DELETE" /* METHOD_DELETE */);
/**
 * HEAD method.
 * @param url   resource URL of the method
 */
exports.HEAD = methodBuilder("HEAD" /* METHOD_HEAD */);
exports.default = RestClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdC1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZXN0LWNsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQkFBMkI7QUFDM0IsaUVBQTZGO0FBRTdGLGlEQUF3RDtBQUN4RCw0QkFBMEI7QUFDMUIsaUNBT2dCO0FBc0JoQjs7R0FFRztBQUNILE1BQXNCLFVBQVU7SUFVOUIsWUFBWSxPQUE4QjtRQVAxQzs7OztXQUlHO1FBQ08sUUFBMEIsR0FBOEIsSUFBSSxDQUFDO1FBR3JFLElBQUksQ0FBQyx1QkFBZ0IsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUM7UUFDNUMsSUFBSSxDQUFDLCtCQUF3QixDQUFDLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixJQUFJLElBQUksQ0FBQztJQUN0RSxDQUFDO0lBRUQsSUFBSSxRQUFRO1FBRVYsT0FBTyxJQUFJLENBQUMsb0JBQWEsQ0FBQyxFQUFFLENBQUE7SUFDOUIsQ0FBQztJQUVELElBQUksS0FBSztRQUVQLE9BQU8sSUFBSSxDQUFDLHVCQUFnQixDQUFDLENBQUE7SUFDL0IsQ0FBQztJQUVELFFBQVEsQ0FBSSxPQUFnQztRQUUxQyxPQUFPLElBQUksQ0FBQyx1QkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBSSxPQUFPLENBQUMsQ0FBQTtJQUNuRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxPQXpCVywrQkFBd0IsRUF5QmxDLG9CQUFhLEVBQUM7UUFFYixPQUFPLG1CQUFtQiw0QkFBa0MsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDO0lBQzVFLENBQUM7SUFFRDs7T0FFRztJQUNILENBQUMsMkJBQW9CLENBQUM7UUFDcEIsT0FBTyxtQkFBbUIsMENBQXlDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQztJQUNuRixDQUFDO0NBQ0Y7QUE1Q0QsZ0NBNENDO0FBRUQ7Ozs7R0FJRztBQUNILFNBQWdCLGNBQWMsQ0FBQyxPQUE0QjtJQUN6RCxPQUFPLFVBQVUsTUFBVztRQUUxQixn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O0FBRXhFOzs7R0FHRztBQUNVLFFBQUEsTUFBTSxHQUFHLGFBQWEsOEJBQXNDLENBQUM7QUFFMUU7OztHQUdHO0FBQ1UsUUFBQSxJQUFJLEdBQUcsYUFBYSwwQkFBb0MsQ0FBQztBQUV0RSxrQkFBZSxVQUFVLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0c2xpbnQ6ZGlzYWJsZTpiYW4tdHlwZXNcbmltcG9ydCB7IEh0dHBNZXRob2QsIEh0dHBSZXF1ZXN0T3B0aW9ucywgSUh0dHBSZXF1ZXN0SGVhZGVycyB9IGZyb20gJy4vaHR0cC1yZXF1ZXN0LW9wdGlvbnMnO1xuaW1wb3J0IHsgSHR0cFNlcnZpY2UgfSBmcm9tICcuL2h0dHAtc2VydmljZSc7XG5pbXBvcnQgeyBOYW1lZFZhbHVlcywgU3RyaW5nTWFwIH0gZnJvbSAnLi9uYW1lZC12YWx1ZXMnO1xuaW1wb3J0ICdyZWZsZWN0LW1ldGFkYXRhJztcbmltcG9ydCB7XG4gIEVudW1SZXN0Q2xpZW50TWV0YWRhdGEsXG4gIFN5bWJvbEJhc2VVcmwsXG4gIFN5bWJvbERlZmF1bHRIZWFkZXJzLFxuICBTeW1ib2xIdHRwQ2xpZW50LFxuICBTeW1ib2xSZXF1ZXN0SW50ZXJjZXB0b3IsIHVybE5vcm1hbGl6ZSxcbiAgdXJsUmVzb2x2ZSxcbn0gZnJvbSAnLi91dGlsJztcbmltcG9ydCB7IElBeGlvc1JlcXVlc3RDb25maWcsIElBeGlvc09ic2VydmFibGUgYXMgT2JzZXJ2YWJsZSB9IGZyb20gJy4vYXhpb3MnO1xuXG5pbnRlcmZhY2UgUGFyYW1ldGVyPFQgPSBhbnk+IHtcbiAga2V5OiBzdHJpbmc7XG4gIHBhcmFtZXRlckluZGV4OiBudW1iZXI7XG4gIGRlZmF1bHRWYWx1ZT86IFRcbn1cblxuZXhwb3J0IHR5cGUgVW5wYWNrUmVxdWVzdE9wdGlvbnM8SCBleHRlbmRzIEh0dHBTZXJ2aWNlPiA9IEggZXh0ZW5kcyBIdHRwU2VydmljZTxpbmZlciBVPiA/IFUgOiBJQXhpb3NSZXF1ZXN0Q29uZmlnXG5cbi8qKlxuICogQW4gaW50ZXJjZXB0b3IgaXMgYSBmdW5jdGlvbiB0aGF0IHRha2VzIHRoZSBwcmVwYXJlZCBIVFRQIHJlcXVlc3QgZGF0YSBhbmQgcmV0dXJucyB0aGVtIG1vZGlmaWVkLlxuICovXG5leHBvcnQgdHlwZSBIdHRwUmVxdWVzdEludGVyY2VwdG9yPEggZXh0ZW5kcyBIdHRwU2VydmljZT4gPSA8VCBleHRlbmRzIEh0dHBSZXF1ZXN0T3B0aW9ucz4ocmVxdWVzdDogVCkgPT4gVW5wYWNrUmVxdWVzdE9wdGlvbnM8SD4gfCBhbnk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJlc3RDbGllbnRPcHRpb25zPEggZXh0ZW5kcyBIdHRwU2VydmljZT5cbntcbiAgaHR0cENsaWVudDogSDtcbiAgcmVxdWVzdEludGVyY2VwdG9yPzogSHR0cFJlcXVlc3RJbnRlcmNlcHRvcjxIPjtcbn1cblxuLyoqXG4gKiBBYnN0cmFjdCBiYXNlIGNsYXNzIGZvciB0aGUgUkVTVCBjbGllbnRzLlxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUmVzdENsaWVudDxIIGV4dGVuZHMgSHR0cFNlcnZpY2UgPSBIdHRwU2VydmljZT4ge1xuICByZWFkb25seSBbU3ltYm9sSHR0cENsaWVudF06IEg7XG5cbiAgLyoqXG4gICAqIFJlcXVlc3QgaW50ZXJjZXB0b3IgYWxsb3dpbmcgdG8gbW9kaWZpeSB0aGUgY29sbGVjdGVkIHJlcXVlc3QgZGF0YSBiZWZvcmUgc2VuZGluZyBpdC5cbiAgICogVHlwaWNhbCB1c2UgaXMgdGhlIGluc2VydGlvbiBvZiBhbiBhdXRob3JpemF0aW9uIHRva2VuIHRvIHRoZSByZXF1ZXN0IGhlYWRlcnMuXG4gICAqIExlYXZlIG51bGwgaWYgeW91IGRvbid0IHdhbnQgdG8gdXNlIGl0LlxuICAgKi9cbiAgcHJvdGVjdGVkIFtTeW1ib2xSZXF1ZXN0SW50ZXJjZXB0b3JdOiBIdHRwUmVxdWVzdEludGVyY2VwdG9yPEg+ID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBJUmVzdENsaWVudE9wdGlvbnM8SD4pIHtcbiAgICB0aGlzW1N5bWJvbEh0dHBDbGllbnRdID0gb3B0aW9ucy5odHRwQ2xpZW50O1xuICAgIHRoaXNbU3ltYm9sUmVxdWVzdEludGVyY2VwdG9yXSA9IG9wdGlvbnMucmVxdWVzdEludGVyY2VwdG9yIHx8IG51bGw7XG4gIH1cblxuICBnZXQgJGJhc2VVUkwoKTogc3RyaW5nXG4gIHtcbiAgICByZXR1cm4gdGhpc1tTeW1ib2xCYXNlVXJsXSgpXG4gIH1cblxuICBnZXQgJGh0dHAoKVxuICB7XG4gICAgcmV0dXJuIHRoaXNbU3ltYm9sSHR0cENsaWVudF1cbiAgfVxuXG4gICRyZXF1ZXN0PFQ+KG9wdGlvbnM6IFVucGFja1JlcXVlc3RPcHRpb25zPEg+KTogT2JzZXJ2YWJsZTxUPlxuICB7XG4gICAgcmV0dXJuIHRoaXNbU3ltYm9sSHR0cENsaWVudF0ucmVxdWVzdDxUPihvcHRpb25zKVxuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGJhc2Ugb2YgdGhlIFJFU1QgQVBJIFVSTC5cbiAgICovXG4gIFtTeW1ib2xCYXNlVXJsXSgpOiBzdHJpbmdcbiAge1xuICAgIHJldHVybiBnZXRUaGlzVHlwZU1ldGFkYXRhKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuQkFTRV9VUkwsIHRoaXMpIHx8IG51bGw7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgZGVmYXVsdCBIVFRQIGhlYWRlcnMgYXR0YWNoZWQgdG8gZWFjaCByZXF1ZXN0LlxuICAgKi9cbiAgW1N5bWJvbERlZmF1bHRIZWFkZXJzXSgpOiBJSHR0cFJlcXVlc3RIZWFkZXJzIHtcbiAgICByZXR1cm4gZ2V0VGhpc1R5cGVNZXRhZGF0YShFbnVtUmVzdENsaWVudE1ldGFkYXRhLkRFRkFVTFRfSEVBREVSUywgdGhpcykgfHwgbnVsbDtcbiAgfVxufVxuXG4vKipcbiAqIFNldHMgdGhlIGRlZmF1bHQgSFRUUCBoZWFkZXJzIGF0dGFjaGVkIHRvIGVhY2ggcmVxdWVzdCB0byB0aGUgUkVTVCBBUEkuXG4gKiBJbnRlbmRlZCB0byB1c2UgYXMgYSBkZWNvcmF0b3I6IEBEZWZhdWx0SGVhZGVycyh7J0hlYWRlcic6ICd2YWx1ZScsICdIZWFkZXIyJzogJ3ZhbHVlJ31cbiAqIEBwYXJhbSBoZWFkZXJzICAgVGhlIGhlYWRlcnMgaW4ga2V5LXZhbHVlIHBhaXJzLlxuICovXG5leHBvcnQgZnVuY3Rpb24gRGVmYXVsdEhlYWRlcnMoaGVhZGVyczogSUh0dHBSZXF1ZXN0SGVhZGVycykge1xuICByZXR1cm4gZnVuY3Rpb24gKFRhcmdldDogYW55KSB7XG5cbiAgICBzZXRDbGFzc01ldGFkYXRhKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuREVGQVVMVF9IRUFERVJTLCBoZWFkZXJzLCBUYXJnZXQpO1xuXG4gICAgcmV0dXJuIFRhcmdldDtcbiAgfTtcbn1cblxuLyoqXG4gKiBTZXRzIHRoZSBiYXNlIFVSTCBvZiB0aGUgUkVTVCBBUEkuXG4gKiBJbnRlbmRlZCB0byB1c2UgYXMgYSBkZWNvcmF0b3I6IEBCYXNlVXJsKFwiaHR0cDovLy4uLlwiKVxuICogQHBhcmFtIHVybCAgIHRoZSBiYXNlIFVSTC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIEJhc2VVcmwodXJsOiBzdHJpbmcgfCBVUkwpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIChUYXJnZXQ6IGFueSkge1xuICAgIHNldENsYXNzTWV0YWRhdGEoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5CQVNFX1VSTCwgdXJsTm9ybWFsaXplKHVybCksIFRhcmdldCk7XG4gICAgcmV0dXJuIFRhcmdldDtcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFRoaXNUeXBlTWV0YWRhdGEobWV0YWRhdGFLZXk6IHN0cmluZywgdGFyZ2V0OiBUaGlzVHlwZTxhbnk+KVxue1xuICByZXR1cm4gUmVmbGVjdC5nZXRNZXRhZGF0YShtZXRhZGF0YUtleSwgUmVmbGVjdC5nZXRQcm90b3R5cGVPZih0YXJnZXQpKVxufVxuXG5leHBvcnQgdHlwZSBJQ2xhc3NXaXRoUHJvdG90eXBlPFQgZXh0ZW5kcyBvYmplY3QgPSBvYmplY3Q+ID0gb2JqZWN0ICYge1xuICBwcm90b3R5cGU6IFQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDbGFzc01ldGFkYXRhKG1ldGFkYXRhS2V5OiBzdHJpbmcsIHRhcmdldDogSUNsYXNzV2l0aFByb3RvdHlwZSlcbntcbiAgcmV0dXJuIFJlZmxlY3QuZ2V0TWV0YWRhdGEobWV0YWRhdGFLZXksIHRhcmdldC5wcm90b3R5cGUpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRDbGFzc01ldGFkYXRhKG1ldGFkYXRhS2V5OiBzdHJpbmcsIG1ldGFkYXRhVmFsdWU6IGFueSwgdGFyZ2V0OiBJQ2xhc3NXaXRoUHJvdG90eXBlKVxue1xuICBSZWZsZWN0LmRlZmluZU1ldGFkYXRhKG1ldGFkYXRhS2V5LCBtZXRhZGF0YVZhbHVlLCB0YXJnZXQucHJvdG90eXBlKTtcbn1cblxuZXhwb3J0IHR5cGUgSUVudW1SZXN0Q2xpZW50TWV0YWRhdGFQYXJhbSA9IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUEFUSCB8IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUVVFUlkgfCBFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0JPRFkgfCBFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0hFQURFUlxuICA7XG5cbmV4cG9ydCB0eXBlIElFbnVtUmVzdENsaWVudE1ldGFkYXRhTWV0aG9kID0gRW51bVJlc3RDbGllbnRNZXRhZGF0YS5NRVRIT0RfR0VUIHwgRW51bVJlc3RDbGllbnRNZXRhZGF0YS5NRVRIT0RfUE9TVCB8IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX1BVVCB8IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX1BBVENIIHwgRW51bVJlc3RDbGllbnRNZXRhZGF0YS5NRVRIT0RfREVMRVRFIHwgRW51bVJlc3RDbGllbnRNZXRhZGF0YS5NRVRIT0RfSEVBRFxuICA7XG5cbmV4cG9ydCB0eXBlIElFbnVtUmVzdENsaWVudE1ldGFkYXRhRXhjbHVkZSA9IEV4Y2x1ZGU8RW51bVJlc3RDbGllbnRNZXRhZGF0YSwgSUVudW1SZXN0Q2xpZW50TWV0YWRhdGFQYXJhbT47XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJlc3RDbGllbnRNZXRob2RNZXRhZGF0YVJldHVyblxue1xuICBbRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9QQVRIXTogUGFyYW1ldGVyW10sXG4gIFtFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX1FVRVJZXTogUGFyYW1ldGVyW10sXG4gIFtFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0JPRFldOiBQYXJhbWV0ZXJbXSxcbiAgW0VudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fSEVBREVSXTogUGFyYW1ldGVyW10sXG5cbiAgW0VudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EXTogSUVudW1SZXN0Q2xpZW50TWV0YWRhdGFNZXRob2QsXG5cbiAgW0VudW1SZXN0Q2xpZW50TWV0YWRhdGEuQkFTRV9VUkxdOiBzdHJpbmcsXG4gIFtFbnVtUmVzdENsaWVudE1ldGFkYXRhLkRFRkFVTFRfSEVBREVSU106IFN0cmluZ01hcCxcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YTxLIGV4dGVuZHMgSUVudW1SZXN0Q2xpZW50TWV0YWRhdGFQYXJhbSwgUkMgZXh0ZW5kcyBSZXN0Q2xpZW50ID0gUmVzdENsaWVudD4obWV0YWRhdGFLZXk6IEssIHRhcmdldDogUkMsIHByb3BlcnR5S2V5OiBzeW1ib2wgfCBzdHJpbmcpOiBJUmVzdENsaWVudE1ldGhvZE1ldGFkYXRhUmV0dXJuW0tdXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVzdENsaWVudE1ldGhvZE1ldGFkYXRhPFQgZXh0ZW5kcyB1bmtub3duLCBSQyBleHRlbmRzIFJlc3RDbGllbnQgPSBSZXN0Q2xpZW50PihtZXRhZGF0YUtleTogSUVudW1SZXN0Q2xpZW50TWV0YWRhdGFFeGNsdWRlLCB0YXJnZXQ6IFJDLCBwcm9wZXJ0eUtleTogc3ltYm9sIHwgc3RyaW5nKTogVFxuZXhwb3J0IGZ1bmN0aW9uIGdldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YTxUIGV4dGVuZHMgYW55LCBSQyBleHRlbmRzIFJlc3RDbGllbnQgPSBSZXN0Q2xpZW50PihtZXRhZGF0YUtleTogRW51bVJlc3RDbGllbnRNZXRhZGF0YSwgdGFyZ2V0OiBSQywgcHJvcGVydHlLZXk6IHN5bWJvbCB8IHN0cmluZyk6IFRcbntcbiAgcmV0dXJuIFJlZmxlY3QuZ2V0TWV0YWRhdGEobWV0YWRhdGFLZXksIHRhcmdldCwgcHJvcGVydHlLZXkgYXMgYW55KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YTxLIGV4dGVuZHMgSUVudW1SZXN0Q2xpZW50TWV0YWRhdGFQYXJhbSwgUkMgZXh0ZW5kcyBSZXN0Q2xpZW50PihtZXRhZGF0YUtleTogSywgdGFyZ2V0OiBSQywgcHJvcGVydHlLZXk6IHN5bWJvbCB8IHN0cmluZywgbWV0YWRhdGFWYWx1ZTogSVJlc3RDbGllbnRNZXRob2RNZXRhZGF0YVJldHVybltLXSk6IHZvaWRcbmV4cG9ydCBmdW5jdGlvbiBzZXRSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGE8UkMgZXh0ZW5kcyBSZXN0Q2xpZW50PihtZXRhZGF0YUtleTogSUVudW1SZXN0Q2xpZW50TWV0YWRhdGFFeGNsdWRlLCB0YXJnZXQ6IFJDLCBwcm9wZXJ0eUtleTogc3ltYm9sIHwgc3RyaW5nLCBtZXRhZGF0YVZhbHVlOiBhbnkpOiB2b2lkXG5leHBvcnQgZnVuY3Rpb24gc2V0UmVzdENsaWVudE1ldGhvZE1ldGFkYXRhPFJDIGV4dGVuZHMgUmVzdENsaWVudD4obWV0YWRhdGFLZXk6IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEsIHRhcmdldDogUkMsIHByb3BlcnR5S2V5OiBzeW1ib2wgfCBzdHJpbmcsIG1ldGFkYXRhVmFsdWU6IGFueSlcbntcbiAgcmV0dXJuIFJlZmxlY3QuZGVmaW5lTWV0YWRhdGEobWV0YWRhdGFLZXksIG1ldGFkYXRhVmFsdWUsIHRhcmdldCwgcHJvcGVydHlLZXkgYXMgYW55KTtcbn1cblxuZnVuY3Rpb24gcGFyYW1CdWlsZGVyKHBhcmFtTmFtZTogSUVudW1SZXN0Q2xpZW50TWV0YWRhdGFQYXJhbSkge1xuICByZXR1cm4gZnVuY3Rpb248RCBleHRlbmRzIGFueT4oa2V5OiBzdHJpbmcsIGRlZmF1bHRWYWx1ZT86IEQpIHtcbiAgICByZXR1cm4gZnVuY3Rpb248UkMgZXh0ZW5kcyBSZXN0Q2xpZW50Pih0YXJnZXQ6IFJDLCBwcm9wZXJ0eUtleTogc3ltYm9sIHwgc3RyaW5nLCBwYXJhbWV0ZXJJbmRleDogbnVtYmVyKSB7XG4gICAgICAvL2NvbnN0IG1ldGFkYXRhS2V5ID0gYCR7U3RyaW5nKHByb3BlcnR5S2V5KX1fJHtwYXJhbU5hbWV9X3BhcmFtZXRlcnNgO1xuICAgICAgY29uc3QgcGFyYW1PYmo6IFBhcmFtZXRlcjxEPiA9IHtcbiAgICAgICAga2V5LFxuICAgICAgICBwYXJhbWV0ZXJJbmRleCxcbiAgICAgICAgZGVmYXVsdFZhbHVlLFxuICAgICAgfTtcblxuICAgICAgbGV0IGFyciA9IGdldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YShwYXJhbU5hbWUsIHRhcmdldCwgcHJvcGVydHlLZXkpO1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkge1xuICAgICAgICBhcnIucHVzaChwYXJhbU9iaik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhcnIgPSBbcGFyYW1PYmpdO1xuICAgICAgfVxuICAgICAgc2V0UmVzdENsaWVudE1ldGhvZE1ldGFkYXRhKHBhcmFtTmFtZSwgdGFyZ2V0LCBwcm9wZXJ0eUtleSwgYXJyKTtcbiAgICB9O1xuICB9O1xufVxuXG4vKipcbiAqIFBhdGggdmFyaWFibGUgb2YgYSBtZXRob2QncyBVUkwsIHR5cGU6IHN0cmluZy5cbiAqIEBwYXJhbSBrZXkgICBwYXRoIGtleSB0byBiaW5kIHZhbHVlLlxuICovXG5leHBvcnQgY29uc3QgUGF0aCA9IHBhcmFtQnVpbGRlcihFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX1BBVEgpO1xuXG4vKipcbiAqIFF1ZXJ5IHZhbHVlIG9mIGEgbWV0aG9kJ3MgVVJMLCB0eXBlOiBzdHJpbmcuXG4gKiBAcGFyYW0ga2V5ICAgcXVlcnkga2V5IHRvIGJpbmQgdmFsdWUuXG4gKi9cbmV4cG9ydCBjb25zdCBRdWVyeSA9IHBhcmFtQnVpbGRlcihFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX1FVRVJZKTtcblxuLyoqXG4gKiBCb2R5IG9mIGEgUkVTVCBtZXRob2QsIHR5cGU6IGtleS12YWx1ZSBwYWlyIG9iamVjdC5cbiAqIE9ubHkgb25lIGJvZHkgcGVyIG1ldGhvZCFcbiAqL1xuZXhwb3J0IGNvbnN0IEJvZHkgPSBwYXJhbUJ1aWxkZXIoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9CT0RZKSgnQm9keScpO1xuXG4vKipcbiAqIEN1c3RvbSBoZWFkZXIgb2YgYSBSRVNUIG1ldGhvZCwgdHlwZTogc3RyaW5nLlxuICogQHBhcmFtIGtleSAgIGhlYWRlciBrZXkgdG8gYmluZCB2YWx1ZS5cbiAqL1xuZXhwb3J0IGNvbnN0IEhlYWRlciA9IHBhcmFtQnVpbGRlcihFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0hFQURFUik7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJlc3RDbGllbnRNZXRob2REZXNjcmlwdG9yPFQgZXh0ZW5kcyBGdW5jdGlvbiwgU00gZXh0ZW5kcyBTdHJpbmdNYXAgPSBTdHJpbmdNYXA+IGV4dGVuZHMgVHlwZWRQcm9wZXJ0eURlc2NyaXB0b3I8VD5cbntcblx0aGVhZGVycz86IE5hbWVkVmFsdWVzPFNNPlxufVxuXG4vKipcbiAqIFNldCBjdXN0b20gaGVhZGVycyBmb3IgYSBSRVNUIG1ldGhvZC5cbiAqIEBwYXJhbSBoZWFkZXJzRGVmICAgIGN1c3RvbSBoZWFkZXJzIGluIGtleS12YWx1ZSBwYWlycy5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIEhlYWRlcnM8U00gZXh0ZW5kcyBTdHJpbmdNYXA+KGhlYWRlcnNEZWY6IFNNKSB7XG4gIHJldHVybiBmdW5jdGlvbjxGIGV4dGVuZHMgRnVuY3Rpb24+KF90YXJnZXQ6IFJlc3RDbGllbnQsIF9wcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBJUmVzdENsaWVudE1ldGhvZERlc2NyaXB0b3I8RiwgU00+KSB7XG4gIFx0Ly8gQHRzLWlnbm9yZVxuICAgIGRlc2NyaXB0b3IuaGVhZGVycyA9IGhlYWRlcnNEZWY7XG4gICAgcmV0dXJuIGRlc2NyaXB0b3I7XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtZXRob2RCdWlsZGVyKG1ldGhvZDogSHR0cE1ldGhvZCkge1xuICByZXR1cm4gZnVuY3Rpb24odXJsOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZnVuY3Rpb248UkMgZXh0ZW5kcyBSZXN0Q2xpZW50ID0gUmVzdENsaWVudD4odGFyZ2V0OiBSQywgcHJvcGVydHlLZXk6IHN5bWJvbCB8IHN0cmluZywgZGVzY3JpcHRvcjogSVJlc3RDbGllbnRNZXRob2REZXNjcmlwdG9yPEZ1bmN0aW9uPikge1xuICAgICAgLy9jb25zdCBwUGF0aCA9IHRhcmdldFtgJHtwcm9wZXJ0eUtleX1fUGF0aF9wYXJhbWV0ZXJzYF0gYXMgUGFyYW1ldGVyW107XG4gICAgICAvL2NvbnN0IHBRdWVyeSA9IHRhcmdldFtgJHtwcm9wZXJ0eUtleX1fUXVlcnlfcGFyYW1ldGVyc2BdIGFzIFBhcmFtZXRlcltdO1xuICAgICAgLy9jb25zdCBwQm9keSA9IHRhcmdldFtgJHtwcm9wZXJ0eUtleX1fQm9keV9wYXJhbWV0ZXJzYF0gYXMgUGFyYW1ldGVyW107XG4gICAgICAvL2NvbnN0IHBIZWFkZXIgPSB0YXJnZXRbYCR7cHJvcGVydHlLZXl9X0hlYWRlcl9wYXJhbWV0ZXJzYF0gYXMgUGFyYW1ldGVyW107XG5cbiAgICAgIGNvbnN0IHBQYXRoID0gZ2V0UmVzdENsaWVudE1ldGhvZE1ldGFkYXRhKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUEFUSCwgdGFyZ2V0LCBwcm9wZXJ0eUtleSk7XG4gICAgICBjb25zdCBwUXVlcnkgPSBnZXRSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGEoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9RVUVSWSwgdGFyZ2V0LCBwcm9wZXJ0eUtleSk7XG4gICAgICBjb25zdCBwQm9keSA9IGdldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YShFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0JPRFksIHRhcmdldCwgcHJvcGVydHlLZXkpO1xuICAgICAgY29uc3QgcEhlYWRlciA9IGdldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YShFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0hFQURFUiwgdGFyZ2V0LCBwcm9wZXJ0eUtleSk7XG5cbiAgICAgIGNvbnN0IG9sZEZuID0gZGVzY3JpcHRvci52YWx1ZTtcblxuICAgICAgc2V0UmVzdENsaWVudE1ldGhvZE1ldGFkYXRhKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9ELCB0YXJnZXQsIHByb3BlcnR5S2V5LCBtZXRob2QpO1xuXG4gICAgICBkZXNjcmlwdG9yLnZhbHVlID0gZnVuY3Rpb24oLi4uYXJnczogYW55W10pIHtcbiAgICAgICAgbGV0IGJvZHkgPSBudWxsO1xuICAgICAgICBpZiAocEJvZHkpIHtcbiAgICAgICAgICBib2R5ID0gSlNPTi5zdHJpbmdpZnkoYXJnc1twQm9keVswXS5wYXJhbWV0ZXJJbmRleF0pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2VsZjogUkMgPSB0aGlzO1xuXG4gICAgICAgIGxldCByZXNVcmw6IHN0cmluZyA9IHVybDtcbiAgICAgICAgaWYgKHBQYXRoKSB7XG4gICAgICAgICAgZm9yIChjb25zdCBrIGluIHBQYXRoKSB7XG4gICAgICAgICAgICBpZiAocFBhdGguaGFzT3duUHJvcGVydHkoaykpIHtcblxuICAgICAgICAgICAgICBsZXQgdmFsdWUgPSBhcmdzW3BQYXRoW2tdLnBhcmFtZXRlckluZGV4XTtcblxuICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgcFBhdGhba10uZGVmYXVsdFZhbHVlICE9PSAndW5kZWZpbmVkJylcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICBcdGxldCBkZWZhdWx0VmFsdWUgPSBwUGF0aFtrXS5kZWZhdWx0VmFsdWU7XG4gICAgICAgICAgICAgIFx0aWYgKHR5cGVvZiBkZWZhdWx0VmFsdWUgPT09ICdmdW5jdGlvbicpXG5cdFx0XHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRcdFx0dmFsdWUgPSBkZWZhdWx0VmFsdWUoKTtcblx0XHRcdFx0XHRcdFx0XHR9XG4gICAgICAgICAgICAgIFx0ZWxzZVxuXHRcdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHRcdHZhbHVlID0gZGVmYXVsdFZhbHVlO1xuXHRcdFx0XHRcdFx0XHRcdH1cbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIHJlc1VybCA9IHJlc1VybC5yZXBsYWNlKCd7JyArIHBQYXRoW2tdLmtleSArICd9JywgdmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IG5ldyBOYW1lZFZhbHVlcygpO1xuICAgICAgICBpZiAocFF1ZXJ5KSB7XG4gICAgICAgICAgcFF1ZXJ5XG4gICAgICAgICAgICAuZmlsdGVyKHAgPT4gYXJnc1twLnBhcmFtZXRlckluZGV4XSlcbiAgICAgICAgICAgIC5mb3JFYWNoKHAgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBrZXkgPSBwLmtleTtcbiAgICAgICAgICAgICAgbGV0IHZhbHVlID0gYXJnc1twLnBhcmFtZXRlckluZGV4XTtcbiAgICAgICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgT2JqZWN0KSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcGFyYW1zLnNldChrZXksIHZhbHVlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgTmFtZWRWYWx1ZXMoc2VsZltTeW1ib2xEZWZhdWx0SGVhZGVyc10oKSk7XG4gICAgICAgIGlmIChkZXNjcmlwdG9yLmhlYWRlcnMpIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IGsgaW4gZGVzY3JpcHRvci5oZWFkZXJzKSB7XG4gICAgICAgICAgICBpZiAoZGVzY3JpcHRvci5oZWFkZXJzLmhhc093blByb3BlcnR5KGspKSB7XG4gICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgaGVhZGVycy5zZXQoaywgZGVzY3JpcHRvci5oZWFkZXJzW2tdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocEhlYWRlcikge1xuICAgICAgICAgIGZvciAoY29uc3QgayBpbiBwSGVhZGVyKSB7XG4gICAgICAgICAgICBpZiAocEhlYWRlci5oYXNPd25Qcm9wZXJ0eShrKSkge1xuICAgICAgICAgICAgICBoZWFkZXJzLnNldChwSGVhZGVyW2tdLmtleSwgYXJnc1twSGVhZGVyW2tdLnBhcmFtZXRlckluZGV4XSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGZpbmFsVXJsID0gdXJsUmVzb2x2ZSggcmVzVXJsLCBzZWxmW1N5bWJvbEJhc2VVcmxdKCkpO1xuICAgICAgICBsZXQgcmVxdWVzdDogSUF4aW9zUmVxdWVzdENvbmZpZyB8IEh0dHBSZXF1ZXN0T3B0aW9ucyA9IG5ldyBIdHRwUmVxdWVzdE9wdGlvbnMoZmluYWxVcmwsIG1ldGhvZCwgYm9keSwgaGVhZGVycywgcGFyYW1zKTtcbiAgICAgICAgaWYgKHRoaXNbU3ltYm9sUmVxdWVzdEludGVyY2VwdG9yXSkge1xuICAgICAgICAgIHJlcXVlc3QgPSB0aGlzW1N5bWJvbFJlcXVlc3RJbnRlcmNlcHRvcl0ocmVxdWVzdCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVxdWVzdCBpbnN0YW5jZW9mIEh0dHBSZXF1ZXN0T3B0aW9ucylcbiAgICAgICAge1xuICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICByZXF1ZXN0ID0gcmVxdWVzdC50b1ZhbHVlKCkgYXMgSUF4aW9zUmVxdWVzdENvbmZpZ1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgb2xkVHJhbnNmb3JtUmVzcG9uc2UgPSByZXF1ZXN0LnRyYW5zZm9ybVJlc3BvbnNlO1xuXG4gICAgICAgIGxldCBuZXdUcmFuc2Zvcm1SZXNwb25zID0gZnVuY3Rpb24gKGRhdGE6IGFueSlcbiAgICAgICAge1xuICAgICAgICAgIGxldCByZXQgPSBvbGRGbi5jYWxsKHNlbGYsIGRhdGEpO1xuXG4gICAgICAgICAgaWYgKHJldCA9PSBudWxsKVxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9sZFRyYW5zZm9ybVJlc3BvbnNlKSlcbiAgICAgICAge1xuICAgICAgICAgIGlmICghb2xkVHJhbnNmb3JtUmVzcG9uc2UpXG4gICAgICAgICAge1xuICAgICAgICAgICAgcmVxdWVzdC50cmFuc2Zvcm1SZXNwb25zZSA9IFtdO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlbHNlXG4gICAgICAgICAge1xuICAgICAgICAgICAgcmVxdWVzdC50cmFuc2Zvcm1SZXNwb25zZSA9IFtvbGRUcmFuc2Zvcm1SZXNwb25zZV07XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgKHJlcXVlc3QudHJhbnNmb3JtUmVzcG9uc2UgYXMgYW55W10pLnB1c2gobmV3VHJhbnNmb3JtUmVzcG9ucyk7XG5cbiAgICAgICAgLy9jb25zb2xlLmxvZyhyZXF1ZXN0KTtcblxuICAgICAgICByZXR1cm4gc2VsZi4kaHR0cC5yZXF1ZXN0KHJlcXVlc3QpO1xuICAgICAgfTtcbiAgICB9O1xuICB9O1xufVxuXG4vKipcbiAqIEdFVCBtZXRob2QuXG4gKiBAcGFyYW0gdXJsICAgcmVzb3VyY2UgVVJMIG9mIHRoZSBtZXRob2RcbiAqL1xuZXhwb3J0IGNvbnN0IEdFVCA9IG1ldGhvZEJ1aWxkZXIoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5NRVRIT0RfR0VUKTtcblxuLyoqXG4gKiBQT1NUIG1ldGhvZC5cbiAqIEBwYXJhbSB1cmwgICByZXNvdXJjZSBVUkwgb2YgdGhlIG1ldGhvZFxuICovXG5leHBvcnQgY29uc3QgUE9TVCA9IG1ldGhvZEJ1aWxkZXIoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5NRVRIT0RfUE9TVCk7XG5cbi8qKlxuICogUFVUIG1ldGhvZC5cbiAqIEBwYXJhbSB1cmwgICByZXNvdXJjZSBVUkwgb2YgdGhlIG1ldGhvZFxuICovXG5leHBvcnQgY29uc3QgUFVUID0gbWV0aG9kQnVpbGRlcihFbnVtUmVzdENsaWVudE1ldGFkYXRhLk1FVEhPRF9QVVQpO1xuXG4vKipcbiAqIFBBVENIIG1ldGhvZC5cbiAqIEBwYXJhbSB1cmwgICByZXNvdXJjZSBVUkwgb2YgdGhlIG1ldGhvZFxuICovXG5leHBvcnQgY29uc3QgUEFUQ0ggPSBtZXRob2RCdWlsZGVyKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX1BBVENIKTtcblxuLyoqXG4gKiBERUxFVEUgbWV0aG9kLlxuICogQHBhcmFtIHVybCAgIHJlc291cmNlIFVSTCBvZiB0aGUgbWV0aG9kXG4gKi9cbmV4cG9ydCBjb25zdCBERUxFVEUgPSBtZXRob2RCdWlsZGVyKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX0RFTEVURSk7XG5cbi8qKlxuICogSEVBRCBtZXRob2QuXG4gKiBAcGFyYW0gdXJsICAgcmVzb3VyY2UgVVJMIG9mIHRoZSBtZXRob2RcbiAqL1xuZXhwb3J0IGNvbnN0IEhFQUQgPSBtZXRob2RCdWlsZGVyKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX0hFQUQpO1xuXG5leHBvcnQgZGVmYXVsdCBSZXN0Q2xpZW50XG4iXX0=