"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
require("reflect-metadata");
// tslint:disable:ban-types
const http_request_options_1 = require("./http-request-options");
const named_values_1 = require("./named-values");
const util_1 = require("./util");
/**
 * Abstract base class for the REST clients.
 */
class RestClient {
    constructor(options) {
        /**
         * Request interceptor allowing to modifiy the collected request data before sending it.
         * Typical use is the insertion of an authorization token to the request headers.
         * Leave null if you don't want to use it.
         */
        this[_a] = null;
        this[util_1.SymbolHttpClient] = options.httpClient;
        this[util_1.SymbolRequestInterceptor] = options.requestInterceptor || null;
    }
    get $baseURL() {
        return this[util_1.SymbolBaseUrl]();
    }
    get $http() {
        return this[util_1.SymbolHttpClient];
    }
    $request(options) {
        return this[util_1.SymbolHttpClient].request(options);
    }
    /**
     * Returns the base of the REST API URL.
     */
    [(_a = util_1.SymbolRequestInterceptor, util_1.SymbolBaseUrl)]() {
        return util_1.getThisTypeMetadata("BASE_URL" /* BASE_URL */, this) || null;
    }
    /**
     * Returns the default HTTP headers attached to each request.
     */
    [util_1.SymbolDefaultHeaders]() {
        return util_1.getThisTypeMetadata("DEFAULT_HEADERS" /* DEFAULT_HEADERS */, this) || null;
    }
}
exports.RestClient = RestClient;
/**
 * Sets the default HTTP headers attached to each request to the REST API.
 * Intended to use as a decorator: @DefaultHeaders({'Header': 'value', 'Header2': 'value'}
 * @param headers   The headers in key-value pairs.
 */
function DefaultHeaders(headers) {
    return Reflect.metadata("DEFAULT_HEADERS" /* DEFAULT_HEADERS */, headers);
}
exports.DefaultHeaders = DefaultHeaders;
/**
 * Sets the base URL of the REST API.
 * Intended to use as a decorator: @BaseUrl("http://...")
 * @param url   the base URL.
 */
function BaseUrl(url) {
    return Reflect.metadata("BASE_URL" /* BASE_URL */, url);
}
exports.BaseUrl = BaseUrl;
function getRestClientMethodMetadata(metadataKey, target, propertyKey) {
    return Reflect.getMetadata(metadataKey, target, propertyKey);
}
exports.getRestClientMethodMetadata = getRestClientMethodMetadata;
function setRestClientMethodMetadata(metadataKey, target, propertyKey, metadataValue) {
    return Reflect.defineMetadata(metadataKey, metadataValue, target, propertyKey);
}
exports.setRestClientMethodMetadata = setRestClientMethodMetadata;
function paramBuilder(paramName) {
    return function (key, defaultValue) {
        return function (target, propertyKey, parameterIndex) {
            //const metadataKey = `${String(propertyKey)}_${paramName}_parameters`;
            const paramObj = {
                key,
                parameterIndex,
                defaultValue,
            };
            let arr = getRestClientMethodMetadata(paramName, target, propertyKey) || [];
            arr.push(paramObj);
            setRestClientMethodMetadata(paramName, target, propertyKey, arr);
        };
    };
}
/**
 * Path variable of a method's URL, type: string.
 * @param key   path key to bind value.
 */
exports.Path = paramBuilder("Path" /* PARAM_PATH */);
/**
 * Query value of a method's URL, type: string.
 * @param key   query key to bind value.
 */
exports.Query = paramBuilder("Query" /* PARAM_QUERY */);
/**
 * Body of a REST method, type: key-value pair object.
 * Only one body per method!
 */
exports.Body = paramBuilder("Body" /* PARAM_BODY */)('Body');
/**
 * Custom header of a REST method, type: string.
 * @param key   header key to bind value.
 */
exports.Header = paramBuilder("Header" /* PARAM_HEADER */);
/**
 * Set custom headers for a REST method.
 * @param headersDef    custom headers in key-value pairs.
 */
function Headers(headersDef) {
    return function (_target, _propertyKey, descriptor) {
        // @ts-ignore
        descriptor.headers = headersDef;
        return descriptor;
    };
}
exports.Headers = Headers;
function methodBuilder(method) {
    return function (url) {
        return function (target, propertyKey, descriptor) {
            //const pPath = target[`${propertyKey}_Path_parameters`] as Parameter[];
            //const pQuery = target[`${propertyKey}_Query_parameters`] as Parameter[];
            //const pBody = target[`${propertyKey}_Body_parameters`] as Parameter[];
            //const pHeader = target[`${propertyKey}_Header_parameters`] as Parameter[];
            const pPath = getRestClientMethodMetadata("Path" /* PARAM_PATH */, target, propertyKey);
            const pQuery = getRestClientMethodMetadata("Query" /* PARAM_QUERY */, target, propertyKey);
            const pBody = getRestClientMethodMetadata("Body" /* PARAM_BODY */, target, propertyKey);
            const pHeader = getRestClientMethodMetadata("Header" /* PARAM_HEADER */, target, propertyKey);
            const oldFn = descriptor.value;
            setRestClientMethodMetadata("METHOD" /* METHOD */, target, propertyKey, method);
            descriptor.value = function (...args) {
                let body = null;
                if (pBody) {
                    body = JSON.stringify(args[pBody[0].parameterIndex]);
                }
                const self = this;
                let resUrl = url;
                if (pPath) {
                    for (const k in pPath) {
                        if (pPath.hasOwnProperty(k)) {
                            let value = args[pPath[k].parameterIndex];
                            if (typeof value === 'undefined' && typeof pPath[k].defaultValue !== 'undefined') {
                                let defaultValue = pPath[k].defaultValue;
                                if (typeof defaultValue === 'function') {
                                    value = defaultValue();
                                }
                                else {
                                    value = defaultValue;
                                }
                            }
                            resUrl = resUrl.replace('{' + pPath[k].key + '}', value);
                        }
                    }
                }
                const params = new named_values_1.NamedValues();
                if (pQuery) {
                    pQuery
                        .filter(p => args[p.parameterIndex])
                        .forEach(p => {
                        const key = p.key;
                        let value = args[p.parameterIndex];
                        if (value instanceof Object) {
                            value = JSON.stringify(value);
                        }
                        params.set(key, value);
                    });
                }
                const headers = new named_values_1.NamedValues(self[util_1.SymbolDefaultHeaders]());
                if (descriptor.headers) {
                    for (const k in descriptor.headers) {
                        if (descriptor.headers.hasOwnProperty(k)) {
                            // @ts-ignore
                            headers.set(k, descriptor.headers[k]);
                        }
                    }
                }
                if (pHeader) {
                    for (const k in pHeader) {
                        if (pHeader.hasOwnProperty(k)) {
                            headers.set(pHeader[k].key, args[pHeader[k].parameterIndex]);
                        }
                    }
                }
                const finalUrl = util_1.urlResolve(resUrl, self[util_1.SymbolBaseUrl]());
                let request = new http_request_options_1.HttpRequestOptions(finalUrl, method, body, headers, params);
                if (this[util_1.SymbolRequestInterceptor]) {
                    request = this[util_1.SymbolRequestInterceptor](request);
                }
                if (request instanceof http_request_options_1.HttpRequestOptions) {
                    // @ts-ignore
                    request = request.toValue();
                }
                const oldTransformResponse = request.transformResponse;
                let newTransformRespons = function (data) {
                    let ret = oldFn.call(self, data);
                    if (ret == null) {
                        return data;
                    }
                    return ret;
                };
                if (!Array.isArray(oldTransformResponse)) {
                    if (!oldTransformResponse) {
                        request.transformResponse = [];
                    }
                    else {
                        request.transformResponse = [oldTransformResponse];
                    }
                }
                request.transformResponse.push(newTransformRespons);
                //console.log(request);
                return self.$http.request(request);
            };
        };
    };
}
exports.methodBuilder = methodBuilder;
/**
 * GET method.
 * @param url   resource URL of the method
 */
exports.GET = methodBuilder("GET" /* METHOD_GET */);
/**
 * POST method.
 * @param url   resource URL of the method
 */
exports.POST = methodBuilder("POST" /* METHOD_POST */);
/**
 * PUT method.
 * @param url   resource URL of the method
 */
exports.PUT = methodBuilder("PUT" /* METHOD_PUT */);
/**
 * PATCH method.
 * @param url   resource URL of the method
 */
exports.PATCH = methodBuilder("PATCH" /* METHOD_PATCH */);
/**
 * DELETE method.
 * @param url   resource URL of the method
 */
exports.DELETE = methodBuilder("DELETE" /* METHOD_DELETE */);
/**
 * HEAD method.
 * @param url   resource URL of the method
 */
exports.HEAD = methodBuilder("HEAD" /* METHOD_HEAD */);
exports.default = RestClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdC1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZXN0LWNsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw0QkFBMEI7QUFDMUIsMkJBQTJCO0FBQzNCLGlFQUE2RjtBQUU3RixpREFBd0Q7QUFFeEQsaUNBUWdCO0FBc0JoQjs7R0FFRztBQUNILE1BQXNCLFVBQVU7SUFVOUIsWUFBWSxPQUE4QjtRQVAxQzs7OztXQUlHO1FBQ08sUUFBMEIsR0FBOEIsSUFBSSxDQUFDO1FBR3JFLElBQUksQ0FBQyx1QkFBZ0IsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUM7UUFDNUMsSUFBSSxDQUFDLCtCQUF3QixDQUFDLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixJQUFJLElBQUksQ0FBQztJQUN0RSxDQUFDO0lBRUQsSUFBSSxRQUFRO1FBRVYsT0FBTyxJQUFJLENBQUMsb0JBQWEsQ0FBQyxFQUFFLENBQUE7SUFDOUIsQ0FBQztJQUVELElBQUksS0FBSztRQUVQLE9BQU8sSUFBSSxDQUFDLHVCQUFnQixDQUFDLENBQUE7SUFDL0IsQ0FBQztJQUVELFFBQVEsQ0FBSSxPQUFnQztRQUUxQyxPQUFPLElBQUksQ0FBQyx1QkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBSSxPQUFPLENBQUMsQ0FBQTtJQUNuRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxPQXpCVywrQkFBd0IsRUF5QmxDLG9CQUFhLEVBQUM7UUFFYixPQUFPLDBCQUFtQiw0QkFBa0MsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDO0lBQzVFLENBQUM7SUFFRDs7T0FFRztJQUNILENBQUMsMkJBQW9CLENBQUM7UUFDcEIsT0FBTywwQkFBbUIsMENBQXlDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQztJQUNuRixDQUFDO0NBQ0Y7QUE1Q0QsZ0NBNENDO0FBRUQ7Ozs7R0FJRztBQUNILFNBQWdCLGNBQWMsQ0FBQyxPQUE0QjtJQUN6RCxPQUFPLE9BQU8sQ0FBQyxRQUFRLDBD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QztZQUNyQyxDQUFDLENBQUM7UUFDSixDQUFDLENBQUM7SUFDSixDQUFDLENBQUM7QUFDSixDQUFDO0FBOUhELHNDQThIQztBQUVEOzs7R0FHRztBQUNVLFFBQUEsR0FBRyxHQUFHLGFBQWEsd0JBQW1DLENBQUM7QUFFcEU7OztHQUdHO0FBQ1UsUUFBQSxJQUFJLEdBQUcsYUFBYSwwQkFBb0MsQ0FBQztBQUV0RTs7O0dBR0c7QUFDVSxRQUFBLEdBQUcsR0FBRyxhQUFhLHdCQUFtQyxDQUFDO0FBRXBFOzs7R0FHRztBQUNVLFFBQUEsS0FBSyxHQUFHLGFBQWEsNEJBQXFDLENBQUM7QUFFeEU7OztHQUdHO0FBQ1UsUUFBQSxNQUFNLEdBQUcsYUFBYSw4QkFBc0MsQ0FBQztBQUUxRTs7O0dBR0c7QUFDVSxRQUFBLElBQUksR0FBRyxhQUFhLDBCQUFvQyxDQUFDO0FBRXRFLGtCQUFlLFVBQVUsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAncmVmbGVjdC1tZXRhZGF0YSc7XG4vLyB0c2xpbnQ6ZGlzYWJsZTpiYW4tdHlwZXNcbmltcG9ydCB7IEh0dHBNZXRob2QsIEh0dHBSZXF1ZXN0T3B0aW9ucywgSUh0dHBSZXF1ZXN0SGVhZGVycyB9IGZyb20gJy4vaHR0cC1yZXF1ZXN0LW9wdGlvbnMnO1xuaW1wb3J0IHsgSHR0cFNlcnZpY2UgfSBmcm9tICcuL2h0dHAtc2VydmljZSc7XG5pbXBvcnQgeyBOYW1lZFZhbHVlcywgU3RyaW5nTWFwIH0gZnJvbSAnLi9uYW1lZC12YWx1ZXMnO1xuXG5pbXBvcnQge1xuXHRFbnVtUmVzdENsaWVudE1ldGFkYXRhLFxuXHRnZXRUaGlzVHlwZU1ldGFkYXRhLFxuXHRTeW1ib2xCYXNlVXJsLFxuXHRTeW1ib2xEZWZhdWx0SGVhZGVycyxcblx0U3ltYm9sSHR0cENsaWVudCxcblx0U3ltYm9sUmVxdWVzdEludGVyY2VwdG9yLFxuXHR1cmxSZXNvbHZlLFxufSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IHsgSUF4aW9zT2JzZXJ2YWJsZSBhcyBPYnNlcnZhYmxlLCBJQXhpb3NSZXF1ZXN0Q29uZmlnIH0gZnJvbSAnLi9heGlvcyc7XG5cbmludGVyZmFjZSBQYXJhbWV0ZXI8VCA9IGFueT4ge1xuICBrZXk6IHN0cmluZztcbiAgcGFyYW1ldGVySW5kZXg6IG51bWJlcjtcbiAgZGVmYXVsdFZhbHVlPzogVFxufVxuXG5leHBvcnQgdHlwZSBVbnBhY2tSZXF1ZXN0T3B0aW9uczxIIGV4dGVuZHMgSHR0cFNlcnZpY2U+ID0gSCBleHRlbmRzIEh0dHBTZXJ2aWNlPGluZmVyIFU+ID8gVSA6IElBeGlvc1JlcXVlc3RDb25maWdcblxuLyoqXG4gKiBBbiBpbnRlcmNlcHRvciBpcyBhIGZ1bmN0aW9uIHRoYXQgdGFrZXMgdGhlIHByZXBhcmVkIEhUVFAgcmVxdWVzdCBkYXRhIGFuZCByZXR1cm5zIHRoZW0gbW9kaWZpZWQuXG4gKi9cbmV4cG9ydCB0eXBlIEh0dHBSZXF1ZXN0SW50ZXJjZXB0b3I8SCBleHRlbmRzIEh0dHBTZXJ2aWNlPiA9IDxUIGV4dGVuZHMgSHR0cFJlcXVlc3RPcHRpb25zPihyZXF1ZXN0OiBUKSA9PiBVbnBhY2tSZXF1ZXN0T3B0aW9uczxIPiB8IGFueTtcblxuZXhwb3J0IGludGVyZmFjZSBJUmVzdENsaWVudE9wdGlvbnM8SCBleHRlbmRzIEh0dHBTZXJ2aWNlPlxue1xuICBodHRwQ2xpZW50OiBIO1xuICByZXF1ZXN0SW50ZXJjZXB0b3I/OiBIdHRwUmVxdWVzdEludGVyY2VwdG9yPEg+O1xufVxuXG4vKipcbiAqIEFic3RyYWN0IGJhc2UgY2xhc3MgZm9yIHRoZSBSRVNUIGNsaWVudHMuXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBSZXN0Q2xpZW50PEggZXh0ZW5kcyBIdHRwU2VydmljZSA9IEh0dHBTZXJ2aWNlPiB7XG4gIHJlYWRvbmx5IFtTeW1ib2xIdHRwQ2xpZW50XTogSDtcblxuICAvKipcbiAgICogUmVxdWVzdCBpbnRlcmNlcHRvciBhbGxvd2luZyB0byBtb2RpZml5IHRoZSBjb2xsZWN0ZWQgcmVxdWVzdCBkYXRhIGJlZm9yZSBzZW5kaW5nIGl0LlxuICAgKiBUeXBpY2FsIHVzZSBpcyB0aGUgaW5zZXJ0aW9uIG9mIGFuIGF1dGhvcml6YXRpb24gdG9rZW4gdG8gdGhlIHJlcXVlc3QgaGVhZGVycy5cbiAgICogTGVhdmUgbnVsbCBpZiB5b3UgZG9uJ3Qgd2FudCB0byB1c2UgaXQuXG4gICAqL1xuICBwcm90ZWN0ZWQgW1N5bWJvbFJlcXVlc3RJbnRlcmNlcHRvcl06IEh0dHBSZXF1ZXN0SW50ZXJjZXB0b3I8SD4gPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IElSZXN0Q2xpZW50T3B0aW9uczxIPikge1xuICAgIHRoaXNbU3ltYm9sSHR0cENsaWVudF0gPSBvcHRpb25zLmh0dHBDbGllbnQ7XG4gICAgdGhpc1tTeW1ib2xSZXF1ZXN0SW50ZXJjZXB0b3JdID0gb3B0aW9ucy5yZXF1ZXN0SW50ZXJjZXB0b3IgfHwgbnVsbDtcbiAgfVxuXG4gIGdldCAkYmFzZVVSTCgpOiBzdHJpbmdcbiAge1xuICAgIHJldHVybiB0aGlzW1N5bWJvbEJhc2VVcmxdKClcbiAgfVxuXG4gIGdldCAkaHR0cCgpXG4gIHtcbiAgICByZXR1cm4gdGhpc1tTeW1ib2xIdHRwQ2xpZW50XVxuICB9XG5cbiAgJHJlcXVlc3Q8VD4ob3B0aW9uczogVW5wYWNrUmVxdWVzdE9wdGlvbnM8SD4pOiBPYnNlcnZhYmxlPFQ+XG4gIHtcbiAgICByZXR1cm4gdGhpc1tTeW1ib2xIdHRwQ2xpZW50XS5yZXF1ZXN0PFQ+KG9wdGlvbnMpXG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgYmFzZSBvZiB0aGUgUkVTVCBBUEkgVVJMLlxuICAgKi9cbiAgW1N5bWJvbEJhc2VVcmxdKCk6IHN0cmluZ1xuICB7XG4gICAgcmV0dXJuIGdldFRoaXNUeXBlTWV0YWRhdGEoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5CQVNFX1VSTCwgdGhpcykgfHwgbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBkZWZhdWx0IEhUVFAgaGVhZGVycyBhdHRhY2hlZCB0byBlYWNoIHJlcXVlc3QuXG4gICAqL1xuICBbU3ltYm9sRGVmYXVsdEhlYWRlcnNdKCk6IElIdHRwUmVxdWVzdEhlYWRlcnMge1xuICAgIHJldHVybiBnZXRUaGlzVHlwZU1ldGFkYXRhKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuREVGQVVMVF9IRUFERVJTLCB0aGlzKSB8fCBudWxsO1xuICB9XG59XG5cbi8qKlxuICogU2V0cyB0aGUgZGVmYXVsdCBIVFRQIGhlYWRlcnMgYXR0YWNoZWQgdG8gZWFjaCByZXF1ZXN0IHRvIHRoZSBSRVNUIEFQSS5cbiAqIEludGVuZGVkIHRvIHVzZSBhcyBhIGRlY29yYXRvcjogQERlZmF1bHRIZWFkZXJzKHsnSGVhZGVyJzogJ3ZhbHVlJywgJ0hlYWRlcjInOiAndmFsdWUnfVxuICogQHBhcmFtIGhlYWRlcnMgICBUaGUgaGVhZGVycyBpbiBrZXktdmFsdWUgcGFpcnMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBEZWZhdWx0SGVhZGVycyhoZWFkZXJzOiBJSHR0cFJlcXVlc3RIZWFkZXJzKSB7XG4gIHJldHVybiBSZWZsZWN0Lm1ldGFkYXRhKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuREVGQVVMVF9IRUFERVJTLCBoZWFkZXJzKTtcbn1cblxuLyoqXG4gKiBTZXRzIHRoZSBiYXNlIFVSTCBvZiB0aGUgUkVTVCBBUEkuXG4gKiBJbnRlbmRlZCB0byB1c2UgYXMgYSBkZWNvcmF0b3I6IEBCYXNlVXJsKFwiaHR0cDovLy4uLlwiKVxuICogQHBhcmFtIHVybCAgIHRoZSBiYXNlIFVSTC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIEJhc2VVcmwodXJsOiBzdHJpbmcgfCBVUkwpIHtcblx0cmV0dXJuIFJlZmxlY3QubWV0YWRhdGEoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5CQVNFX1VSTCwgdXJsKVxufVxuXG5leHBvcnQgdHlwZSBJQ2xhc3NXaXRoUHJvdG90eXBlPFQgZXh0ZW5kcyBvYmplY3QgPSBvYmplY3Q+ID0gb2JqZWN0ICYge1xuICBwcm90b3R5cGU6IFQ7XG59XG5cbmV4cG9ydCB0eXBlIElFbnVtUmVzdENsaWVudE1ldGFkYXRhUGFyYW0gPSBFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX1BBVEggfCBFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX1FVRVJZIHwgRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9CT0RZIHwgRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9IRUFERVJcbiAgO1xuXG5leHBvcnQgdHlwZSBJRW51bVJlc3RDbGllbnRNZXRhZGF0YU1ldGhvZCA9IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX0dFVCB8IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX1BPU1QgfCBFbnVtUmVzdENsaWVudE1ldGFkYXRhLk1FVEhPRF9QVVQgfCBFbnVtUmVzdENsaWVudE1ldGFkYXRhLk1FVEhPRF9QQVRDSCB8IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX0RFTEVURSB8IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX0hFQURcbiAgO1xuXG5leHBvcnQgdHlwZSBJRW51bVJlc3RDbGllbnRNZXRhZGF0YUV4Y2x1ZGUgPSBFeGNsdWRlPEVudW1SZXN0Q2xpZW50TWV0YWRhdGEsIElFbnVtUmVzdENsaWVudE1ldGFkYXRhUGFyYW0+O1xuXG5leHBvcnQgaW50ZXJmYWNlIElSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGFSZXR1cm5cbntcbiAgW0VudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUEFUSF06IFBhcmFtZXRlcltdLFxuICBbRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9RVUVSWV06IFBhcmFtZXRlcltdLFxuICBbRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9CT0RZXTogUGFyYW1ldGVyW10sXG4gIFtFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0hFQURFUl06IFBhcmFtZXRlcltdLFxuXG4gIFtFbnVtUmVzdENsaWVudE1ldGFkYXRhLk1FVEhPRF06IElFbnVtUmVzdENsaWVudE1ldGFkYXRhTWV0aG9kLFxuXG4gIFtFbnVtUmVzdENsaWVudE1ldGFkYXRhLkJBU0VfVVJMXTogc3RyaW5nLFxuICBbRW51bVJlc3RDbGllbnRNZXRhZGF0YS5ERUZBVUxUX0hFQURFUlNdOiBTdHJpbmdNYXAsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGE8SyBleHRlbmRzIElFbnVtUmVzdENsaWVudE1ldGFkYXRhUGFyYW0sIFJDIGV4dGVuZHMgUmVzdENsaWVudCA9IFJlc3RDbGllbnQ+KG1ldGFkYXRhS2V5OiBLLCB0YXJnZXQ6IFJDLCBwcm9wZXJ0eUtleTogc3ltYm9sIHwgc3RyaW5nKTogSVJlc3RDbGllbnRNZXRob2RNZXRhZGF0YVJldHVybltLXVxuZXhwb3J0IGZ1bmN0aW9uIGdldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YTxUIGV4dGVuZHMgdW5rbm93biwgUkMgZXh0ZW5kcyBSZXN0Q2xpZW50ID0gUmVzdENsaWVudD4obWV0YWRhdGFLZXk6IElFbnVtUmVzdENsaWVudE1ldGFkYXRhRXhjbHVkZSwgdGFyZ2V0OiBSQywgcHJvcGVydHlLZXk6IHN5bWJvbCB8IHN0cmluZyk6IFRcbmV4cG9ydCBmdW5jdGlvbiBnZXRSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGE8VCBleHRlbmRzIGFueSwgUkMgZXh0ZW5kcyBSZXN0Q2xpZW50ID0gUmVzdENsaWVudD4obWV0YWRhdGFLZXk6IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEsIHRhcmdldDogUkMsIHByb3BlcnR5S2V5OiBzeW1ib2wgfCBzdHJpbmcpOiBUXG57XG4gIHJldHVybiBSZWZsZWN0LmdldE1ldGFkYXRhKG1ldGFkYXRhS2V5LCB0YXJnZXQsIHByb3BlcnR5S2V5IGFzIGFueSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGE8SyBleHRlbmRzIElFbnVtUmVzdENsaWVudE1ldGFkYXRhUGFyYW0sIFJDIGV4dGVuZHMgUmVzdENsaWVudD4obWV0YWRhdGFLZXk6IEssIHRhcmdldDogUkMsIHByb3BlcnR5S2V5OiBzeW1ib2wgfCBzdHJpbmcsIG1ldGFkYXRhVmFsdWU6IElSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGFSZXR1cm5bS10pOiB2b2lkXG5leHBvcnQgZnVuY3Rpb24gc2V0UmVzdENsaWVudE1ldGhvZE1ldGFkYXRhPFJDIGV4dGVuZHMgUmVzdENsaWVudD4obWV0YWRhdGFLZXk6IElFbnVtUmVzdENsaWVudE1ldGFkYXRhRXhjbHVkZSwgdGFyZ2V0OiBSQywgcHJvcGVydHlLZXk6IHN5bWJvbCB8IHN0cmluZywgbWV0YWRhdGFWYWx1ZTogYW55KTogdm9pZFxuZXhwb3J0IGZ1bmN0aW9uIHNldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YTxSQyBleHRlbmRzIFJlc3RDbGllbnQ+KG1ldGFkYXRhS2V5OiBFbnVtUmVzdENsaWVudE1ldGFkYXRhLCB0YXJnZXQ6IFJDLCBwcm9wZXJ0eUtleTogc3ltYm9sIHwgc3RyaW5nLCBtZXRhZGF0YVZhbHVlOiBhbnkpXG57XG4gIHJldHVybiBSZWZsZWN0LmRlZmluZU1ldGFkYXRhKG1ldGFkYXRhS2V5LCBtZXRhZGF0YVZhbHVlLCB0YXJnZXQsIHByb3BlcnR5S2V5IGFzIGFueSk7XG59XG5cbmZ1bmN0aW9uIHBhcmFtQnVpbGRlcihwYXJhbU5hbWU6IElFbnVtUmVzdENsaWVudE1ldGFkYXRhUGFyYW0pIHtcbiAgcmV0dXJuIGZ1bmN0aW9uKGtleTogc3RyaW5nLCBkZWZhdWx0VmFsdWU/OiBhbnkpIHtcbiAgICByZXR1cm4gZnVuY3Rpb248UkMgZXh0ZW5kcyBSZXN0Q2xpZW50Pih0YXJnZXQ6IFJDLCBwcm9wZXJ0eUtleTogYW55LCBwYXJhbWV0ZXJJbmRleDogbnVtYmVyKSB7XG4gICAgICAvL2NvbnN0IG1ldGFkYXRhS2V5ID0gYCR7U3RyaW5nKHByb3BlcnR5S2V5KX1fJHtwYXJhbU5hbWV9X3BhcmFtZXRlcnNgO1xuICAgICAgY29uc3QgcGFyYW1PYmo6IFBhcmFtZXRlciA9IHtcbiAgICAgICAga2V5LFxuICAgICAgICBwYXJhbWV0ZXJJbmRleCxcbiAgICAgICAgZGVmYXVsdFZhbHVlLFxuICAgICAgfTtcblxuICAgICAgbGV0IGFyciA9IGdldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YShwYXJhbU5hbWUsIHRhcmdldCwgcHJvcGVydHlLZXkpIHx8IFtdO1xuICAgICAgYXJyLnB1c2gocGFyYW1PYmopO1xuICAgICAgc2V0UmVzdENsaWVudE1ldGhvZE1ldGFkYXRhKHBhcmFtTmFtZSwgdGFyZ2V0LCBwcm9wZXJ0eUtleSwgYXJyKTtcbiAgICB9O1xuICB9O1xufVxuXG4vKipcbiAqIFBhdGggdmFyaWFibGUgb2YgYSBtZXRob2QncyBVUkwsIHR5cGU6IHN0cmluZy5cbiAqIEBwYXJhbSBrZXkgICBwYXRoIGtleSB0byBiaW5kIHZhbHVlLlxuICovXG5leHBvcnQgY29uc3QgUGF0aCA9IHBhcmFtQnVpbGRlcihFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX1BBVEgpO1xuXG4vKipcbiAqIFF1ZXJ5IHZhbHVlIG9mIGEgbWV0aG9kJ3MgVVJMLCB0eXBlOiBzdHJpbmcuXG4gKiBAcGFyYW0ga2V5ICAgcXVlcnkga2V5IHRvIGJpbmQgdmFsdWUuXG4gKi9cbmV4cG9ydCBjb25zdCBRdWVyeSA9IHBhcmFtQnVpbGRlcihFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX1FVRVJZKTtcblxuLyoqXG4gKiBCb2R5IG9mIGEgUkVTVCBtZXRob2QsIHR5cGU6IGtleS12YWx1ZSBwYWlyIG9iamVjdC5cbiAqIE9ubHkgb25lIGJvZHkgcGVyIG1ldGhvZCFcbiAqL1xuZXhwb3J0IGNvbnN0IEJvZHkgPSBwYXJhbUJ1aWxkZXIoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9CT0RZKSgnQm9keScpO1xuXG4vKipcbiAqIEN1c3RvbSBoZWFkZXIgb2YgYSBSRVNUIG1ldGhvZCwgdHlwZTogc3RyaW5nLlxuICogQHBhcmFtIGtleSAgIGhlYWRlciBrZXkgdG8gYmluZCB2YWx1ZS5cbiAqL1xuZXhwb3J0IGNvbnN0IEhlYWRlciA9IHBhcmFtQnVpbGRlcihFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0hFQURFUik7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJlc3RDbGllbnRNZXRob2REZXNjcmlwdG9yPFQgZXh0ZW5kcyBGdW5jdGlvbiwgU00gZXh0ZW5kcyBTdHJpbmdNYXAgPSBTdHJpbmdNYXA+IGV4dGVuZHMgVHlwZWRQcm9wZXJ0eURlc2NyaXB0b3I8VD5cbntcblx0aGVhZGVycz86IE5hbWVkVmFsdWVzPFNNPlxufVxuXG4vKipcbiAqIFNldCBjdXN0b20gaGVhZGVycyBmb3IgYSBSRVNUIG1ldGhvZC5cbiAqIEBwYXJhbSBoZWFkZXJzRGVmICAgIGN1c3RvbSBoZWFkZXJzIGluIGtleS12YWx1ZSBwYWlycy5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIEhlYWRlcnM8U00gZXh0ZW5kcyBTdHJpbmdNYXA+KGhlYWRlcnNEZWY6IFNNKSB7XG4gIHJldHVybiBmdW5jdGlvbjxGIGV4dGVuZHMgRnVuY3Rpb24+KF90YXJnZXQ6IFJlc3RDbGllbnQsIF9wcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBJUmVzdENsaWVudE1ldGhvZERlc2NyaXB0b3I8RiwgU00+KSB7XG4gIFx0Ly8gQHRzLWlnbm9yZVxuICAgIGRlc2NyaXB0b3IuaGVhZGVycyA9IGhlYWRlcnNEZWY7XG4gICAgcmV0dXJuIGRlc2NyaXB0b3I7XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtZXRob2RCdWlsZGVyKG1ldGhvZDogSHR0cE1ldGhvZCkge1xuICByZXR1cm4gZnVuY3Rpb24odXJsOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZnVuY3Rpb248UkMgZXh0ZW5kcyBSZXN0Q2xpZW50ID0gUmVzdENsaWVudD4odGFyZ2V0OiBSQywgcHJvcGVydHlLZXk6IHN5bWJvbCB8IHN0cmluZywgZGVzY3JpcHRvcjogSVJlc3RDbGllbnRNZXRob2REZXNjcmlwdG9yPEZ1bmN0aW9uPikge1xuICAgICAgLy9jb25zdCBwUGF0aCA9IHRhcmdldFtgJHtwcm9wZXJ0eUtleX1fUGF0aF9wYXJhbWV0ZXJzYF0gYXMgUGFyYW1ldGVyW107XG4gICAgICAvL2NvbnN0IHBRdWVyeSA9IHRhcmdldFtgJHtwcm9wZXJ0eUtleX1fUXVlcnlfcGFyYW1ldGVyc2BdIGFzIFBhcmFtZXRlcltdO1xuICAgICAgLy9jb25zdCBwQm9keSA9IHRhcmdldFtgJHtwcm9wZXJ0eUtleX1fQm9keV9wYXJhbWV0ZXJzYF0gYXMgUGFyYW1ldGVyW107XG4gICAgICAvL2NvbnN0IHBIZWFkZXIgPSB0YXJnZXRbYCR7cHJvcGVydHlLZXl9X0hlYWRlcl9wYXJhbWV0ZXJzYF0gYXMgUGFyYW1ldGVyW107XG5cbiAgICAgIGNvbnN0IHBQYXRoID0gZ2V0UmVzdENsaWVudE1ldGhvZE1ldGFkYXRhKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUEFUSCwgdGFyZ2V0LCBwcm9wZXJ0eUtleSk7XG4gICAgICBjb25zdCBwUXVlcnkgPSBnZXRSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGEoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9RVUVSWSwgdGFyZ2V0LCBwcm9wZXJ0eUtleSk7XG4gICAgICBjb25zdCBwQm9keSA9IGdldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YShFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0JPRFksIHRhcmdldCwgcHJvcGVydHlLZXkpO1xuICAgICAgY29uc3QgcEhlYWRlciA9IGdldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YShFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0hFQURFUiwgdGFyZ2V0LCBwcm9wZXJ0eUtleSk7XG5cbiAgICAgIGNvbnN0IG9sZEZuID0gZGVzY3JpcHRvci52YWx1ZTtcblxuICAgICAgc2V0UmVzdENsaWVudE1ldGhvZE1ldGFkYXRhKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9ELCB0YXJnZXQsIHByb3BlcnR5S2V5LCBtZXRob2QpO1xuXG4gICAgICBkZXNjcmlwdG9yLnZhbHVlID0gZnVuY3Rpb24oLi4uYXJnczogYW55W10pIHtcbiAgICAgICAgbGV0IGJvZHkgPSBudWxsO1xuICAgICAgICBpZiAocEJvZHkpIHtcbiAgICAgICAgICBib2R5ID0gSlNPTi5zdHJpbmdpZnkoYXJnc1twQm9keVswXS5wYXJhbWV0ZXJJbmRleF0pO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc2VsZjogUkMgPSB0aGlzO1xuXG4gICAgICAgIGxldCByZXNVcmw6IHN0cmluZyA9IHVybDtcbiAgICAgICAgaWYgKHBQYXRoKSB7XG4gICAgICAgICAgZm9yIChjb25zdCBrIGluIHBQYXRoKSB7XG4gICAgICAgICAgICBpZiAocFBhdGguaGFzT3duUHJvcGVydHkoaykpIHtcblxuICAgICAgICAgICAgICBsZXQgdmFsdWUgPSBhcmdzW3BQYXRoW2tdLnBhcmFtZXRlckluZGV4XTtcblxuICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgcFBhdGhba10uZGVmYXVsdFZhbHVlICE9PSAndW5kZWZpbmVkJylcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICBcdGxldCBkZWZhdWx0VmFsdWUgPSBwUGF0aFtrXS5kZWZhdWx0VmFsdWU7XG4gICAgICAgICAgICAgIFx0aWYgKHR5cGVvZiBkZWZhdWx0VmFsdWUgPT09ICdmdW5jdGlvbicpXG5cdFx0XHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRcdFx0dmFsdWUgPSBkZWZhdWx0VmFsdWUoKTtcblx0XHRcdFx0XHRcdFx0XHR9XG4gICAgICAgICAgICAgIFx0ZWxzZVxuXHRcdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHRcdHZhbHVlID0gZGVmYXVsdFZhbHVlO1xuXHRcdFx0XHRcdFx0XHRcdH1cbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIHJlc1VybCA9IHJlc1VybC5yZXBsYWNlKCd7JyArIHBQYXRoW2tdLmtleSArICd9JywgdmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IG5ldyBOYW1lZFZhbHVlcygpO1xuICAgICAgICBpZiAocFF1ZXJ5KSB7XG4gICAgICAgICAgcFF1ZXJ5XG4gICAgICAgICAgICAuZmlsdGVyKHAgPT4gYXJnc1twLnBhcmFtZXRlckluZGV4XSlcbiAgICAgICAgICAgIC5mb3JFYWNoKHAgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBrZXkgPSBwLmtleTtcbiAgICAgICAgICAgICAgbGV0IHZhbHVlID0gYXJnc1twLnBhcmFtZXRlckluZGV4XTtcbiAgICAgICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgT2JqZWN0KSB7XG4gICAgICAgICAgICAgICAgdmFsdWUgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcGFyYW1zLnNldChrZXksIHZhbHVlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgTmFtZWRWYWx1ZXMoc2VsZltTeW1ib2xEZWZhdWx0SGVhZGVyc10oKSk7XG4gICAgICAgIGlmIChkZXNjcmlwdG9yLmhlYWRlcnMpIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IGsgaW4gZGVzY3JpcHRvci5oZWFkZXJzKSB7XG4gICAgICAgICAgICBpZiAoZGVzY3JpcHRvci5oZWFkZXJzLmhhc093blByb3BlcnR5KGspKSB7XG4gICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgaGVhZGVycy5zZXQoaywgZGVzY3JpcHRvci5oZWFkZXJzW2tdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocEhlYWRlcikge1xuICAgICAgICAgIGZvciAoY29uc3QgayBpbiBwSGVhZGVyKSB7XG4gICAgICAgICAgICBpZiAocEhlYWRlci5oYXNPd25Qcm9wZXJ0eShrKSkge1xuICAgICAgICAgICAgICBoZWFkZXJzLnNldChwSGVhZGVyW2tdLmtleSwgYXJnc1twSGVhZGVyW2tdLnBhcmFtZXRlckluZGV4XSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGZpbmFsVXJsID0gdXJsUmVzb2x2ZSggcmVzVXJsLCBzZWxmW1N5bWJvbEJhc2VVcmxdKCkpO1xuICAgICAgICBsZXQgcmVxdWVzdDogSUF4aW9zUmVxdWVzdENvbmZpZyB8IEh0dHBSZXF1ZXN0T3B0aW9ucyA9IG5ldyBIdHRwUmVxdWVzdE9wdGlvbnMoZmluYWxVcmwsIG1ldGhvZCwgYm9keSwgaGVhZGVycywgcGFyYW1zKTtcbiAgICAgICAgaWYgKHRoaXNbU3ltYm9sUmVxdWVzdEludGVyY2VwdG9yXSkge1xuICAgICAgICAgIHJlcXVlc3QgPSB0aGlzW1N5bWJvbFJlcXVlc3RJbnRlcmNlcHRvcl0ocmVxdWVzdCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVxdWVzdCBpbnN0YW5jZW9mIEh0dHBSZXF1ZXN0T3B0aW9ucylcbiAgICAgICAge1xuICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICByZXF1ZXN0ID0gcmVxdWVzdC50b1ZhbHVlKCkgYXMgSUF4aW9zUmVxdWVzdENvbmZpZ1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgb2xkVHJhbnNmb3JtUmVzcG9uc2UgPSByZXF1ZXN0LnRyYW5zZm9ybVJlc3BvbnNlO1xuXG4gICAgICAgIGxldCBuZXdUcmFuc2Zvcm1SZXNwb25zID0gZnVuY3Rpb24gKGRhdGE6IGFueSlcbiAgICAgICAge1xuICAgICAgICAgIGxldCByZXQgPSBvbGRGbi5jYWxsKHNlbGYsIGRhdGEpO1xuXG4gICAgICAgICAgaWYgKHJldCA9PSBudWxsKVxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiByZXQ7XG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9sZFRyYW5zZm9ybVJlc3BvbnNlKSlcbiAgICAgICAge1xuICAgICAgICAgIGlmICghb2xkVHJhbnNmb3JtUmVzcG9uc2UpXG4gICAgICAgICAge1xuICAgICAgICAgICAgcmVxdWVzdC50cmFuc2Zvcm1SZXNwb25zZSA9IFtdO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlbHNlXG4gICAgICAgICAge1xuICAgICAgICAgICAgcmVxdWVzdC50cmFuc2Zvcm1SZXNwb25zZSA9IFtvbGRUcmFuc2Zvcm1SZXNwb25zZV07XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgKHJlcXVlc3QudHJhbnNmb3JtUmVzcG9uc2UgYXMgYW55W10pLnB1c2gobmV3VHJhbnNmb3JtUmVzcG9ucyk7XG5cbiAgICAgICAgLy9jb25zb2xlLmxvZyhyZXF1ZXN0KTtcblxuICAgICAgICByZXR1cm4gc2VsZi4kaHR0cC5yZXF1ZXN0KHJlcXVlc3QpO1xuICAgICAgfTtcbiAgICB9O1xuICB9O1xufVxuXG4vKipcbiAqIEdFVCBtZXRob2QuXG4gKiBAcGFyYW0gdXJsICAgcmVzb3VyY2UgVVJMIG9mIHRoZSBtZXRob2RcbiAqL1xuZXhwb3J0IGNvbnN0IEdFVCA9IG1ldGhvZEJ1aWxkZXIoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5NRVRIT0RfR0VUKTtcblxuLyoqXG4gKiBQT1NUIG1ldGhvZC5cbiAqIEBwYXJhbSB1cmwgICByZXNvdXJjZSBVUkwgb2YgdGhlIG1ldGhvZFxuICovXG5leHBvcnQgY29uc3QgUE9TVCA9IG1ldGhvZEJ1aWxkZXIoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5NRVRIT0RfUE9TVCk7XG5cbi8qKlxuICogUFVUIG1ldGhvZC5cbiAqIEBwYXJhbSB1cmwgICByZXNvdXJjZSBVUkwgb2YgdGhlIG1ldGhvZFxuICovXG5leHBvcnQgY29uc3QgUFVUID0gbWV0aG9kQnVpbGRlcihFbnVtUmVzdENsaWVudE1ldGFkYXRhLk1FVEhPRF9QVVQpO1xuXG4vKipcbiAqIFBBVENIIG1ldGhvZC5cbiAqIEBwYXJhbSB1cmwgICByZXNvdXJjZSBVUkwgb2YgdGhlIG1ldGhvZFxuICovXG5leHBvcnQgY29uc3QgUEFUQ0ggPSBtZXRob2RCdWlsZGVyKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX1BBVENIKTtcblxuLyoqXG4gKiBERUxFVEUgbWV0aG9kLlxuICogQHBhcmFtIHVybCAgIHJlc291cmNlIFVSTCBvZiB0aGUgbWV0aG9kXG4gKi9cbmV4cG9ydCBjb25zdCBERUxFVEUgPSBtZXRob2RCdWlsZGVyKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX0RFTEVURSk7XG5cbi8qKlxuICogSEVBRCBtZXRob2QuXG4gKiBAcGFyYW0gdXJsICAgcmVzb3VyY2UgVVJMIG9mIHRoZSBtZXRob2RcbiAqL1xuZXhwb3J0IGNvbnN0IEhFQUQgPSBtZXRob2RCdWlsZGVyKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX0hFQUQpO1xuXG5leHBvcnQgZGVmYXVsdCBSZXN0Q2xpZW50XG4iXX0=