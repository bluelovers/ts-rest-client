"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable:ban-types
const http_request_options_1 = require("./http-request-options");
const named_values_1 = require("./named-values");
require("reflect-metadata");
const util_1 = require("./util");
/**
 * Abstract base class for the REST clients.
 */
class RestClient {
    constructor(options) {
        /**
         * Request interceptor allowing to modifiy the collected request data before sending it.
         * Typical use is the insertion of an authorization token to the request headers.
         * Leave null if you don't want to use it.
         */
        this[_a] = null;
        this[util_1.SymbolHttpClient] = options.httpClient;
        this[util_1.SymbolRequestInterceptor] = options.requestInterceptor || null;
    }
    get $baseURL() {
        return this[util_1.SymbolBaseUrl]();
    }
    get $http() {
        return this[util_1.SymbolHttpClient];
    }
    $request(options) {
        return this[util_1.SymbolHttpClient].request(options);
    }
    /**
     * Returns the base of the REST API URL.
     */
    [(_a = util_1.SymbolRequestInterceptor, util_1.SymbolBaseUrl)]() {
        return Reflect.getMetadata("BASE_URL" /* BASE_URL */, Reflect.getPrototypeOf(this)) || null;
    }
    /**
     * Returns the default HTTP headers attached to each request.
     */
    [util_1.SymbolDefaultHeaders]() {
        return Reflect.getMetadata("DEFAULT_HEADERS" /* DEFAULT_HEADERS */, Reflect.getPrototypeOf(this)) || null;
    }
}
exports.RestClient = RestClient;
/**
 * Sets the default HTTP headers attached to each request to the REST API.
 * Intended to use as a decorator: @DefaultHeaders({'Header': 'value', 'Header2': 'value'}
 * @param headers   The headers in key-value pairs.
 */
function DefaultHeaders(headers) {
    return function (Target) {
        setClassMetadata("DEFAULT_HEADERS" /* DEFAULT_HEADERS */, headers, Target);
        return Target;
    };
}
exports.DefaultHeaders = DefaultHeaders;
/**
 * Sets the base URL of the REST API.
 * Intended to use as a decorator: @BaseUrl("http://...")
 * @param url   the base URL.
 */
function BaseUrl(url) {
    return function (Target) {
        setClassMetadata("BASE_URL" /* BASE_URL */, util_1.urlNormalize(url), Target);
        return Target;
    };
}
exports.BaseUrl = BaseUrl;
function setClassMetadata(metadataKey, metadataValue, target) {
    Reflect.defineMetadata(metadataKey, metadataValue, target.prototype);
}
exports.setClassMetadata = setClassMetadata;
function getRestClientMethodMetadata(metadataKey, target, propertyKey) {
    return Reflect.getMetadata(metadataKey, target, propertyKey);
}
exports.getRestClientMethodMetadata = getRestClientMethodMetadata;
function setRestClientMethodMetadata(metadataKey, target, propertyKey, metadataValue) {
    return Reflect.defineMetadata(metadataKey, metadataValue, target, propertyKey);
}
exports.setRestClientMethodMetadata = setRestClientMethodMetadata;
function paramBuilder(paramName) {
    return function (key) {
        return function (target, propertyKey, parameterIndex) {
            //const metadataKey = `${String(propertyKey)}_${paramName}_parameters`;
            const paramObj = {
                key,
                parameterIndex,
            };
            let arr = getRestClientMethodMetadata(paramName, target, propertyKey);
            if (Array.isArray(arr)) {
                arr.push(paramObj);
            }
            else {
                arr = [paramObj];
            }
            setRestClientMethodMetadata(paramName, target, propertyKey, arr);
        };
    };
}
/**
 * Path variable of a method's URL, type: string.
 * @param key   path key to bind value.
 */
exports.Path = paramBuilder("Path" /* PARAM_PATH */);
/**
 * Query value of a method's URL, type: string.
 * @param key   query key to bind value.
 */
exports.Query = paramBuilder("Query" /* PARAM_QUERY */);
/**
 * Body of a REST method, type: key-value pair object.
 * Only one body per method!
 */
exports.Body = paramBuilder("Body" /* PARAM_BODY */)('Body');
/**
 * Custom header of a REST method, type: string.
 * @param key   header key to bind value.
 */
exports.Header = paramBuilder("Header" /* PARAM_HEADER */);
/**
 * Set custom headers for a REST method.
 * @param headersDef    custom headers in key-value pairs.
 */
function Headers(headersDef) {
    return function (_target, _propertyKey, descriptor) {
        // @ts-ignore
        descriptor.headers = headersDef;
        return descriptor;
    };
}
exports.Headers = Headers;
function methodBuilder(method) {
    return function (url) {
        return function (target, propertyKey, descriptor) {
            //const pPath = target[`${propertyKey}_Path_parameters`] as Parameter[];
            //const pQuery = target[`${propertyKey}_Query_parameters`] as Parameter[];
            //const pBody = target[`${propertyKey}_Body_parameters`] as Parameter[];
            //const pHeader = target[`${propertyKey}_Header_parameters`] as Parameter[];
            const pPath = getRestClientMethodMetadata("Path" /* PARAM_PATH */, target, propertyKey);
            const pQuery = getRestClientMethodMetadata("Query" /* PARAM_QUERY */, target, propertyKey);
            const pBody = getRestClientMethodMetadata("Body" /* PARAM_BODY */, target, propertyKey);
            const pHeader = getRestClientMethodMetadata("Header" /* PARAM_HEADER */, target, propertyKey);
            const oldFn = descriptor.value;
            setRestClientMethodMetadata("METHOD" /* METHOD */, target, propertyKey, method);
            descriptor.value = function (...args) {
                let body = null;
                if (pBody) {
                    body = JSON.stringify(args[pBody[0].parameterIndex]);
                }
                const self = this;
                let resUrl = url;
                if (pPath) {
                    for (const k in pPath) {
                        if (pPath.hasOwnProperty(k)) {
                            resUrl = resUrl.replace('{' + pPath[k].key + '}', args[pPath[k].parameterIndex]);
                        }
                    }
                }
                const params = new named_values_1.NamedValues();
                if (pQuery) {
                    pQuery
                        .filter(p => args[p.parameterIndex])
                        .forEach(p => {
                        const key = p.key;
                        let value = args[p.parameterIndex];
                        if (value instanceof Object) {
                            value = JSON.stringify(value);
                        }
                        params.set(key, value);
                    });
                }
                const headers = new named_values_1.NamedValues(self[util_1.SymbolDefaultHeaders]());
                if (descriptor.headers) {
                    for (const k in descriptor.headers) {
                        if (descriptor.headers.hasOwnProperty(k)) {
                            // @ts-ignore
                            headers.set(k, descriptor.headers[k]);
                        }
                    }
                }
                if (pHeader) {
                    for (const k in pHeader) {
                        if (pHeader.hasOwnProperty(k)) {
                            headers.set(pHeader[k].key, args[pHeader[k].parameterIndex]);
                        }
                    }
                }
                const finalUrl = util_1.urlResolve(resUrl, self[util_1.SymbolBaseUrl]());
                let request = new http_request_options_1.HttpRequestOptions(finalUrl, method, body, headers, params);
                if (this[util_1.SymbolRequestInterceptor]) {
                    request = this[util_1.SymbolRequestInterceptor](request);
                }
                if (request instanceof http_request_options_1.HttpRequestOptions) {
                    // @ts-ignore
                    request = request.toValue();
                }
                const oldTransformResponse = request.transformResponse;
                let newTransformRespons = function (data) {
                    let ret = oldFn.call(self, data);
                    if (ret == null) {
                        return data;
                    }
                    return ret;
                };
                if (!Array.isArray(oldTransformResponse)) {
                    if (!oldTransformResponse) {
                        request.transformResponse = [];
                    }
                    else {
                        request.transformResponse = [oldTransformResponse];
                    }
                }
                request.transformResponse.push(newTransformRespons);
                return self.$http.request(request);
            };
        };
    };
}
exports.methodBuilder = methodBuilder;
/**
 * GET method.
 * @param url   resource URL of the method
 */
exports.GET = methodBuilder("GET" /* METHOD_GET */);
/**
 * POST method.
 * @param url   resource URL of the method
 */
exports.POST = methodBuilder("POST" /* METHOD_POST */);
/**
 * PUT method.
 * @param url   resource URL of the method
 */
exports.PUT = methodBuilder("PUT" /* METHOD_PUT */);
/**
 * PATCH method.
 * @param url   resource URL of the method
 */
exports.PATCH = methodBuilder("PATCH" /* METHOD_PATCH */);
/**
 * DELETE method.
 * @param url   resource URL of the method
 */
exports.DELETE = methodBuilder("DELETE" /* METHOD_DELETE */);
/**
 * HEAD method.
 * @param url   resource URL of the method
 */
exports.HEAD = methodBuilder("HEAD" /* METHOD_HEAD */);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdC1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZXN0LWNsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQkFBMkI7QUFDM0IsaUVBQXdFO0FBRXhFLGlEQUF3RDtBQUN4RCw0QkFBMEI7QUFDMUIsaUNBUWdCO0FBcUJoQjs7R0FFRztBQUNILE1BQXNCLFVBQVU7SUFVOUIsWUFBWSxPQUE4QjtRQVAxQzs7OztXQUlHO1FBQ08sUUFBMEIsR0FBOEIsSUFBSSxDQUFDO1FBR3JFLElBQUksQ0FBQyx1QkFBZ0IsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUM7UUFDNUMsSUFBSSxDQUFDLCtCQUF3QixDQUFDLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixJQUFJLElBQUksQ0FBQztJQUN0RSxDQUFDO0lBRUQsSUFBSSxRQUFRO1FBRVYsT0FBTyxJQUFJLENBQUMsb0JBQWEsQ0FBQyxFQUFFLENBQUE7SUFDOUIsQ0FBQztJQUVELElBQUksS0FBSztRQUVQLE9BQU8sSUFBSSxDQUFDLHVCQUFnQixDQUFDLENBQUE7SUFDL0IsQ0FBQztJQUVELFFBQVEsQ0FBSSxPQUFnQztRQUUxQyxPQUFPLElBQUksQ0FBQyx1QkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBSSxPQUFPLENBQUMsQ0FBQTtJQUNuRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxPQXpCVywrQkFBd0IsRUF5QmxDLG9CQUFhLEVBQUM7UUFFYixPQUFPLE9BQU8sQ0FBQyxXQUFXLDRCQUFrQyxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDO0lBQ3BHLENBQUM7SUFFRDs7T0FFRztJQUNILENBQUMsMkJBQW9CLENBQUM7UUFDcEIsT0FBTyxPQUFPLENBQUMsV0FBVywwQ0FBeUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQztJQUMzRyxDQUFDO0NBQ0Y7QUE1Q0QsZ0NBNENDO0FB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QTJCLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7Z0JBRS9ELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDckMsQ0FBQyxDQUFDO1FBQ0osQ0FBQyxDQUFDO0lBQ0osQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQTVHRCxzQ0E0R0M7QUFFRDs7O0dBR0c7QUFDVSxRQUFBLEdBQUcsR0FBRyxhQUFhLHdCQUFtQyxDQUFDO0FBRXBFOzs7R0FHRztBQUNVLFFBQUEsSUFBSSxHQUFHLGFBQWEsMEJBQW9DLENBQUM7QUFFdEU7OztHQUdHO0FBQ1UsUUFBQSxHQUFHLEdBQUcsYUFBYSx3QkFBbUMsQ0FBQztBQUVwRTs7O0dBR0c7QUFDVSxRQUFBLEtBQUssR0FBRyxhQUFhLDRCQUFxQyxDQUFDO0FBRXhFOzs7R0FHRztBQUNVLFFBQUEsTUFBTSxHQUFHLGFBQWEsOEJBQXNDLENBQUM7QUFFMUU7OztHQUdHO0FBQ1UsUUFBQSxJQUFJLEdBQUcsYUFBYSwwQkFBb0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlOmJhbi10eXBlc1xuaW1wb3J0IHsgSHR0cE1ldGhvZCwgSHR0cFJlcXVlc3RPcHRpb25zIH0gZnJvbSAnLi9odHRwLXJlcXVlc3Qtb3B0aW9ucyc7XG5pbXBvcnQgeyBIdHRwU2VydmljZSB9IGZyb20gJy4vaHR0cC1zZXJ2aWNlJztcbmltcG9ydCB7IE5hbWVkVmFsdWVzLCBTdHJpbmdNYXAgfSBmcm9tICcuL25hbWVkLXZhbHVlcyc7XG5pbXBvcnQgJ3JlZmxlY3QtbWV0YWRhdGEnO1xuaW1wb3J0IHtcbiAgRW51bVJlc3RDbGllbnRNZXRhZGF0YSxcbiAgU3ltYm9sQmFzZVVybCxcbiAgU3ltYm9sRGVmYXVsdEhlYWRlcnMsXG4gIFN5bWJvbEh0dHBDbGllbnQsXG4gIFN5bWJvbFJlcXVlc3RJbnRlcmNlcHRvciwgdXJsTm9ybWFsaXplLFxuICB1cmxSZXNvbHZlLFxuICBPYnNlcnZhYmxlXG59IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgeyBJQXhpb3NSZXF1ZXN0Q29uZmlnIH0gZnJvbSAnLi9heGlvcyc7XG5cbmludGVyZmFjZSBQYXJhbWV0ZXIge1xuICBrZXk6IHN0cmluZztcbiAgcGFyYW1ldGVySW5kZXg6IG51bWJlcjtcbn1cblxudHlwZSBVbnBhY2tSZXF1ZXN0T3B0aW9uczxIIGV4dGVuZHMgSHR0cFNlcnZpY2U+ID0gSCBleHRlbmRzIEh0dHBTZXJ2aWNlPGluZmVyIFU+ID8gVSA6IElBeGlvc1JlcXVlc3RDb25maWdcblxuLyoqXG4gKiBBbiBpbnRlcmNlcHRvciBpcyBhIGZ1bmN0aW9uIHRoYXQgdGFrZXMgdGhlIHByZXBhcmVkIEhUVFAgcmVxdWVzdCBkYXRhIGFuZCByZXR1cm5zIHRoZW0gbW9kaWZpZWQuXG4gKi9cbmV4cG9ydCB0eXBlIEh0dHBSZXF1ZXN0SW50ZXJjZXB0b3I8SCBleHRlbmRzIEh0dHBTZXJ2aWNlPiA9IDxUIGV4dGVuZHMgSHR0cFJlcXVlc3RPcHRpb25zPihyZXF1ZXN0OiBUKSA9PiBVbnBhY2tSZXF1ZXN0T3B0aW9uczxIPiB8IGFueTtcblxuZXhwb3J0IGludGVyZmFjZSBJUmVzdENsaWVudE9wdGlvbnM8SCBleHRlbmRzIEh0dHBTZXJ2aWNlPlxue1xuICBodHRwQ2xpZW50OiBIO1xuICByZXF1ZXN0SW50ZXJjZXB0b3I/OiBIdHRwUmVxdWVzdEludGVyY2VwdG9yPEg+O1xufVxuXG4vKipcbiAqIEFic3RyYWN0IGJhc2UgY2xhc3MgZm9yIHRoZSBSRVNUIGNsaWVudHMuXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBSZXN0Q2xpZW50PEggZXh0ZW5kcyBIdHRwU2VydmljZSA9IEh0dHBTZXJ2aWNlPiB7XG4gIHJlYWRvbmx5IFtTeW1ib2xIdHRwQ2xpZW50XTogSDtcblxuICAvKipcbiAgICogUmVxdWVzdCBpbnRlcmNlcHRvciBhbGxvd2luZyB0byBtb2RpZml5IHRoZSBjb2xsZWN0ZWQgcmVxdWVzdCBkYXRhIGJlZm9yZSBzZW5kaW5nIGl0LlxuICAgKiBUeXBpY2FsIHVzZSBpcyB0aGUgaW5zZXJ0aW9uIG9mIGFuIGF1dGhvcml6YXRpb24gdG9rZW4gdG8gdGhlIHJlcXVlc3QgaGVhZGVycy5cbiAgICogTGVhdmUgbnVsbCBpZiB5b3UgZG9uJ3Qgd2FudCB0byB1c2UgaXQuXG4gICAqL1xuICBwcm90ZWN0ZWQgW1N5bWJvbFJlcXVlc3RJbnRlcmNlcHRvcl06IEh0dHBSZXF1ZXN0SW50ZXJjZXB0b3I8SD4gPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IElSZXN0Q2xpZW50T3B0aW9uczxIPikge1xuICAgIHRoaXNbU3ltYm9sSHR0cENsaWVudF0gPSBvcHRpb25zLmh0dHBDbGllbnQ7XG4gICAgdGhpc1tTeW1ib2xSZXF1ZXN0SW50ZXJjZXB0b3JdID0gb3B0aW9ucy5yZXF1ZXN0SW50ZXJjZXB0b3IgfHwgbnVsbDtcbiAgfVxuXG4gIGdldCAkYmFzZVVSTCgpOiBzdHJpbmdcbiAge1xuICAgIHJldHVybiB0aGlzW1N5bWJvbEJhc2VVcmxdKClcbiAgfVxuXG4gIGdldCAkaHR0cCgpXG4gIHtcbiAgICByZXR1cm4gdGhpc1tTeW1ib2xIdHRwQ2xpZW50XVxuICB9XG5cbiAgJHJlcXVlc3Q8VD4ob3B0aW9uczogVW5wYWNrUmVxdWVzdE9wdGlvbnM8SD4pOiBPYnNlcnZhYmxlPFQ+XG4gIHtcbiAgICByZXR1cm4gdGhpc1tTeW1ib2xIdHRwQ2xpZW50XS5yZXF1ZXN0PFQ+KG9wdGlvbnMpXG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgYmFzZSBvZiB0aGUgUkVTVCBBUEkgVVJMLlxuICAgKi9cbiAgW1N5bWJvbEJhc2VVcmxdKCk6IHN0cmluZ1xuICB7XG4gICAgcmV0dXJuIFJlZmxlY3QuZ2V0TWV0YWRhdGEoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5CQVNFX1VSTCwgUmVmbGVjdC5nZXRQcm90b3R5cGVPZih0aGlzKSkgfHwgbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBkZWZhdWx0IEhUVFAgaGVhZGVycyBhdHRhY2hlZCB0byBlYWNoIHJlcXVlc3QuXG4gICAqL1xuICBbU3ltYm9sRGVmYXVsdEhlYWRlcnNdKCk6IFN0cmluZ01hcCB7XG4gICAgcmV0dXJuIFJlZmxlY3QuZ2V0TWV0YWRhdGEoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5ERUZBVUxUX0hFQURFUlMsIFJlZmxlY3QuZ2V0UHJvdG90eXBlT2YodGhpcykpIHx8IG51bGw7XG4gIH1cbn1cblxuLyoqXG4gKiBTZXRzIHRoZSBkZWZhdWx0IEhUVFAgaGVhZGVycyBhdHRhY2hlZCB0byBlYWNoIHJlcXVlc3QgdG8gdGhlIFJFU1QgQVBJLlxuICogSW50ZW5kZWQgdG8gdXNlIGFzIGEgZGVjb3JhdG9yOiBARGVmYXVsdEhlYWRlcnMoeydIZWFkZXInOiAndmFsdWUnLCAnSGVhZGVyMic6ICd2YWx1ZSd9XG4gKiBAcGFyYW0gaGVhZGVycyAgIFRoZSBoZWFkZXJzIGluIGtleS12YWx1ZSBwYWlycy5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIERlZmF1bHRIZWFkZXJzKGhlYWRlcnM6IFN0cmluZ01hcCkge1xuICByZXR1cm4gZnVuY3Rpb24gKFRhcmdldDogYW55KSB7XG5cbiAgICBzZXRDbGFzc01ldGFkYXRhKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuREVGQVVMVF9IRUFERVJTLCBoZWFkZXJzLCBUYXJnZXQpO1xuXG4gICAgcmV0dXJuIFRhcmdldDtcbiAgfTtcbn1cblxuLyoqXG4gKiBTZXRzIHRoZSBiYXNlIFVSTCBvZiB0aGUgUkVTVCBBUEkuXG4gKiBJbnRlbmRlZCB0byB1c2UgYXMgYSBkZWNvcmF0b3I6IEBCYXNlVXJsKFwiaHR0cDovLy4uLlwiKVxuICogQHBhcmFtIHVybCAgIHRoZSBiYXNlIFVSTC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIEJhc2VVcmwodXJsOiBzdHJpbmcgfCBVUkwpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIChUYXJnZXQ6IGFueSkge1xuICAgIHNldENsYXNzTWV0YWRhdGEoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5CQVNFX1VSTCwgdXJsTm9ybWFsaXplKHVybCksIFRhcmdldCk7XG4gICAgcmV0dXJuIFRhcmdldDtcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldENsYXNzTWV0YWRhdGEobWV0YWRhdGFLZXk6IHN0cmluZywgbWV0YWRhdGFWYWx1ZTogYW55LCB0YXJnZXQ6IG9iamVjdCAmIHtcbiAgcHJvdG90eXBlPzogYW55O1xufSlcbntcbiAgUmVmbGVjdC5kZWZpbmVNZXRhZGF0YShtZXRhZGF0YUtleSwgbWV0YWRhdGFWYWx1ZSwgdGFyZ2V0LnByb3RvdHlwZSk7XG59XG5cbmV4cG9ydCB0eXBlIElFbnVtUmVzdENsaWVudE1ldGFkYXRhUGFyYW0gPSBFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX1BBVEggfCBFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX1FVRVJZIHwgRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9CT0RZIHwgRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9IRUFERVJcbiAgO1xuXG5leHBvcnQgdHlwZSBJRW51bVJlc3RDbGllbnRNZXRhZGF0YU1ldGhvZCA9IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX0dFVCB8IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX1BPU1QgfCBFbnVtUmVzdENsaWVudE1ldGFkYXRhLk1FVEhPRF9QVVQgfCBFbnVtUmVzdENsaWVudE1ldGFkYXRhLk1FVEhPRF9QQVRDSCB8IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX0RFTEVURSB8IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX0hFQURcbiAgO1xuXG5leHBvcnQgdHlwZSBJRW51bVJlc3RDbGllbnRNZXRhZGF0YUV4Y2x1ZGUgPSBFeGNsdWRlPEVudW1SZXN0Q2xpZW50TWV0YWRhdGEsIElFbnVtUmVzdENsaWVudE1ldGFkYXRhUGFyYW0+O1xuXG5leHBvcnQgaW50ZXJmYWNlIElSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGFSZXR1cm5cbntcbiAgW0VudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUEFUSF06IFBhcmFtZXRlcltdLFxuICBbRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9RVUVSWV06IFBhcmFtZXRlcltdLFxuICBbRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9CT0RZXTogUGFyYW1ldGVyW10sXG4gIFtFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0hFQURFUl06IFBhcmFtZXRlcltdLFxuXG4gIFtFbnVtUmVzdENsaWVudE1ldGFkYXRhLk1FVEhPRF06IElFbnVtUmVzdENsaWVudE1ldGFkYXRhTWV0aG9kLFxuXG4gIFtFbnVtUmVzdENsaWVudE1ldGFkYXRhLkJBU0VfVVJMXTogc3RyaW5nLFxuICBbRW51bVJlc3RDbGllbnRNZXRhZGF0YS5ERUZBVUxUX0hFQURFUlNdOiBTdHJpbmdNYXAsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGE8SyBleHRlbmRzIElFbnVtUmVzdENsaWVudE1ldGFkYXRhUGFyYW0sIFJDIGV4dGVuZHMgUmVzdENsaWVudCA9IFJlc3RDbGllbnQ+KG1ldGFkYXRhS2V5OiBLLCB0YXJnZXQ6IFJDLCBwcm9wZXJ0eUtleTogc3ltYm9sIHwgc3RyaW5nKTogSVJlc3RDbGllbnRNZXRob2RNZXRhZGF0YVJldHVybltLXVxuZXhwb3J0IGZ1bmN0aW9uIGdldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YTxUIGV4dGVuZHMgdW5rbm93biwgUkMgZXh0ZW5kcyBSZXN0Q2xpZW50ID0gUmVzdENsaWVudD4obWV0YWRhdGFLZXk6IElFbnVtUmVzdENsaWVudE1ldGFkYXRhRXhjbHVkZSwgdGFyZ2V0OiBSQywgcHJvcGVydHlLZXk6IHN5bWJvbCB8IHN0cmluZyk6IFRcbmV4cG9ydCBmdW5jdGlvbiBnZXRSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGE8VCBleHRlbmRzIGFueSwgUkMgZXh0ZW5kcyBSZXN0Q2xpZW50ID0gUmVzdENsaWVudD4obWV0YWRhdGFLZXk6IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEsIHRhcmdldDogUkMsIHByb3BlcnR5S2V5OiBzeW1ib2wgfCBzdHJpbmcpOiBUXG57XG4gIHJldHVybiBSZWZsZWN0LmdldE1ldGFkYXRhKG1ldGFkYXRhS2V5LCB0YXJnZXQsIHByb3BlcnR5S2V5IGFzIGFueSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGE8SyBleHRlbmRzIElFbnVtUmVzdENsaWVudE1ldGFkYXRhUGFyYW0sIFJDIGV4dGVuZHMgUmVzdENsaWVudD4obWV0YWRhdGFLZXk6IEssIHRhcmdldDogUkMsIHByb3BlcnR5S2V5OiBzeW1ib2wgfCBzdHJpbmcsIG1ldGFkYXRhVmFsdWU6IElSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGFSZXR1cm5bS10pOiB2b2lkXG5leHBvcnQgZnVuY3Rpb24gc2V0UmVzdENsaWVudE1ldGhvZE1ldGFkYXRhPFJDIGV4dGVuZHMgUmVzdENsaWVudD4obWV0YWRhdGFLZXk6IElFbnVtUmVzdENsaWVudE1ldGFkYXRhRXhjbHVkZSwgdGFyZ2V0OiBSQywgcHJvcGVydHlLZXk6IHN5bWJvbCB8IHN0cmluZywgbWV0YWRhdGFWYWx1ZTogYW55KTogdm9pZFxuZXhwb3J0IGZ1bmN0aW9uIHNldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YTxSQyBleHRlbmRzIFJlc3RDbGllbnQ+KG1ldGFkYXRhS2V5OiBFbnVtUmVzdENsaWVudE1ldGFkYXRhLCB0YXJnZXQ6IFJDLCBwcm9wZXJ0eUtleTogc3ltYm9sIHwgc3RyaW5nLCBtZXRhZGF0YVZhbHVlOiBhbnkpXG57XG4gIHJldHVybiBSZWZsZWN0LmRlZmluZU1ldGFkYXRhKG1ldGFkYXRhS2V5LCBtZXRhZGF0YVZhbHVlLCB0YXJnZXQsIHByb3BlcnR5S2V5IGFzIGFueSk7XG59XG5cbmZ1bmN0aW9uIHBhcmFtQnVpbGRlcihwYXJhbU5hbWU6IElFbnVtUmVzdENsaWVudE1ldGFkYXRhUGFyYW0pIHtcbiAgcmV0dXJuIGZ1bmN0aW9uKGtleTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uPFJDIGV4dGVuZHMgUmVzdENsaWVudD4odGFyZ2V0OiBSQywgcHJvcGVydHlLZXk6IHN5bWJvbCB8IHN0cmluZywgcGFyYW1ldGVySW5kZXg6IG51bWJlcikge1xuICAgICAgLy9jb25zdCBtZXRhZGF0YUtleSA9IGAke1N0cmluZyhwcm9wZXJ0eUtleSl9XyR7cGFyYW1OYW1lfV9wYXJhbWV0ZXJzYDtcbiAgICAgIGNvbnN0IHBhcmFtT2JqOiBQYXJhbWV0ZXIgPSB7XG4gICAgICAgIGtleSxcbiAgICAgICAgcGFyYW1ldGVySW5kZXgsXG4gICAgICB9O1xuXG4gICAgICBsZXQgYXJyID0gZ2V0UmVzdENsaWVudE1ldGhvZE1ldGFkYXRhKHBhcmFtTmFtZSwgdGFyZ2V0LCBwcm9wZXJ0eUtleSk7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7XG4gICAgICAgIGFyci5wdXNoKHBhcmFtT2JqKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFyciA9IFtwYXJhbU9ial07XG4gICAgICB9XG4gICAgICBzZXRSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGEocGFyYW1OYW1lLCB0YXJnZXQsIHByb3BlcnR5S2V5LCBhcnIpO1xuICAgIH07XG4gIH07XG59XG5cbi8qKlxuICogUGF0aCB2YXJpYWJsZSBvZiBhIG1ldGhvZCdzIFVSTCwgdHlwZTogc3RyaW5nLlxuICogQHBhcmFtIGtleSAgIHBhdGgga2V5IHRvIGJpbmQgdmFsdWUuXG4gKi9cbmV4cG9ydCBjb25zdCBQYXRoID0gcGFyYW1CdWlsZGVyKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUEFUSCk7XG5cbi8qKlxuICogUXVlcnkgdmFsdWUgb2YgYSBtZXRob2QncyBVUkwsIHR5cGU6IHN0cmluZy5cbiAqIEBwYXJhbSBrZXkgICBxdWVyeSBrZXkgdG8gYmluZCB2YWx1ZS5cbiAqL1xuZXhwb3J0IGNvbnN0IFF1ZXJ5ID0gcGFyYW1CdWlsZGVyKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUVVFUlkpO1xuXG4vKipcbiAqIEJvZHkgb2YgYSBSRVNUIG1ldGhvZCwgdHlwZToga2V5LXZhbHVlIHBhaXIgb2JqZWN0LlxuICogT25seSBvbmUgYm9keSBwZXIgbWV0aG9kIVxuICovXG5leHBvcnQgY29uc3QgQm9keSA9IHBhcmFtQnVpbGRlcihFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0JPRFkpKCdCb2R5Jyk7XG5cbi8qKlxuICogQ3VzdG9tIGhlYWRlciBvZiBhIFJFU1QgbWV0aG9kLCB0eXBlOiBzdHJpbmcuXG4gKiBAcGFyYW0ga2V5ICAgaGVhZGVyIGtleSB0byBiaW5kIHZhbHVlLlxuICovXG5leHBvcnQgY29uc3QgSGVhZGVyID0gcGFyYW1CdWlsZGVyKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fSEVBREVSKTtcblxuZXhwb3J0IGludGVyZmFjZSBJUmVzdENsaWVudE1ldGhvZERlc2NyaXB0b3I8VCBleHRlbmRzIEZ1bmN0aW9uLCBTTSBleHRlbmRzIFN0cmluZ01hcCA9IFN0cmluZ01hcD4gZXh0ZW5kcyBUeXBlZFByb3BlcnR5RGVzY3JpcHRvcjxUPlxue1xuXHRoZWFkZXJzPzogTmFtZWRWYWx1ZXM8U00+XG59XG5cbi8qKlxuICogU2V0IGN1c3RvbSBoZWFkZXJzIGZvciBhIFJFU1QgbWV0aG9kLlxuICogQHBhcmFtIGhlYWRlcnNEZWYgICAgY3VzdG9tIGhlYWRlcnMgaW4ga2V5LXZhbHVlIHBhaXJzLlxuICovXG5leHBvcnQgZnVuY3Rpb24gSGVhZGVyczxTTSBleHRlbmRzIFN0cmluZ01hcD4oaGVhZGVyc0RlZjogU00pIHtcbiAgcmV0dXJuIGZ1bmN0aW9uPEYgZXh0ZW5kcyBGdW5jdGlvbj4oX3RhcmdldDogUmVzdENsaWVudCwgX3Byb3BlcnR5S2V5OiBzdHJpbmcsIGRlc2NyaXB0b3I6IElSZXN0Q2xpZW50TWV0aG9kRGVzY3JpcHRvcjxGLCBTTT4pIHtcbiAgXHQvLyBAdHMtaWdub3JlXG4gICAgZGVzY3JpcHRvci5oZWFkZXJzID0gaGVhZGVyc0RlZjtcbiAgICByZXR1cm4gZGVzY3JpcHRvcjtcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ldGhvZEJ1aWxkZXIobWV0aG9kOiBIdHRwTWV0aG9kKSB7XG4gIHJldHVybiBmdW5jdGlvbih1cmw6IHN0cmluZykge1xuICAgIHJldHVybiBmdW5jdGlvbjxSQyBleHRlbmRzIFJlc3RDbGllbnQgPSBSZXN0Q2xpZW50Pih0YXJnZXQ6IFJDLCBwcm9wZXJ0eUtleTogc3ltYm9sIHwgc3RyaW5nLCBkZXNjcmlwdG9yOiBJUmVzdENsaWVudE1ldGhvZERlc2NyaXB0b3I8RnVuY3Rpb24+KSB7XG4gICAgICAvL2NvbnN0IHBQYXRoID0gdGFyZ2V0W2Ake3Byb3BlcnR5S2V5fV9QYXRoX3BhcmFtZXRlcnNgXSBhcyBQYXJhbWV0ZXJbXTtcbiAgICAgIC8vY29uc3QgcFF1ZXJ5ID0gdGFyZ2V0W2Ake3Byb3BlcnR5S2V5fV9RdWVyeV9wYXJhbWV0ZXJzYF0gYXMgUGFyYW1ldGVyW107XG4gICAgICAvL2NvbnN0IHBCb2R5ID0gdGFyZ2V0W2Ake3Byb3BlcnR5S2V5fV9Cb2R5X3BhcmFtZXRlcnNgXSBhcyBQYXJhbWV0ZXJbXTtcbiAgICAgIC8vY29uc3QgcEhlYWRlciA9IHRhcmdldFtgJHtwcm9wZXJ0eUtleX1fSGVhZGVyX3BhcmFtZXRlcnNgXSBhcyBQYXJhbWV0ZXJbXTtcblxuICAgICAgY29uc3QgcFBhdGggPSBnZXRSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGEoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9QQVRILCB0YXJnZXQsIHByb3BlcnR5S2V5KTtcbiAgICAgIGNvbnN0IHBRdWVyeSA9IGdldFJlc3RDbGllbnRNZXRob2RNZXRhZGF0YShFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX1FVRVJZLCB0YXJnZXQsIHByb3BlcnR5S2V5KTtcbiAgICAgIGNvbnN0IHBCb2R5ID0gZ2V0UmVzdENsaWVudE1ldGhvZE1ldGFkYXRhKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fQk9EWSwgdGFyZ2V0LCBwcm9wZXJ0eUtleSk7XG4gICAgICBjb25zdCBwSGVhZGVyID0gZ2V0UmVzdENsaWVudE1ldGhvZE1ldGFkYXRhKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fSEVBREVSLCB0YXJnZXQsIHByb3BlcnR5S2V5KTtcblxuICAgICAgY29uc3Qgb2xkRm4gPSBkZXNjcmlwdG9yLnZhbHVlO1xuXG4gICAgICBzZXRSZXN0Q2xpZW50TWV0aG9kTWV0YWRhdGEoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5NRVRIT0QsIHRhcmdldCwgcHJvcGVydHlLZXksIG1ldGhvZCk7XG5cbiAgICAgIGRlc2NyaXB0b3IudmFsdWUgPSBmdW5jdGlvbiguLi5hcmdzOiBhbnlbXSkge1xuICAgICAgICBsZXQgYm9keSA9IG51bGw7XG4gICAgICAgIGlmIChwQm9keSkge1xuICAgICAgICAgIGJvZHkgPSBKU09OLnN0cmluZ2lmeShhcmdzW3BCb2R5WzBdLnBhcmFtZXRlckluZGV4XSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzZWxmOiBSQyA9IHRoaXM7XG5cbiAgICAgICAgbGV0IHJlc1VybDogc3RyaW5nID0gdXJsO1xuICAgICAgICBpZiAocFBhdGgpIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IGsgaW4gcFBhdGgpIHtcbiAgICAgICAgICAgIGlmIChwUGF0aC5oYXNPd25Qcm9wZXJ0eShrKSkge1xuICAgICAgICAgICAgICByZXNVcmwgPSByZXNVcmwucmVwbGFjZSgneycgKyBwUGF0aFtrXS5rZXkgKyAnfScsIGFyZ3NbcFBhdGhba10ucGFyYW1ldGVySW5kZXhdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwYXJhbXMgPSBuZXcgTmFtZWRWYWx1ZXMoKTtcbiAgICAgICAgaWYgKHBRdWVyeSkge1xuICAgICAgICAgIHBRdWVyeVxuICAgICAgICAgICAgLmZpbHRlcihwID0+IGFyZ3NbcC5wYXJhbWV0ZXJJbmRleF0pXG4gICAgICAgICAgICAuZm9yRWFjaChwID0+IHtcbiAgICAgICAgICAgICAgY29uc3Qga2V5ID0gcC5rZXk7XG4gICAgICAgICAgICAgIGxldCB2YWx1ZSA9IGFyZ3NbcC5wYXJhbWV0ZXJJbmRleF07XG4gICAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE9iamVjdCkge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHBhcmFtcy5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBoZWFkZXJzID0gbmV3IE5hbWVkVmFsdWVzKHNlbGZbU3ltYm9sRGVmYXVsdEhlYWRlcnNdKCkpO1xuICAgICAgICBpZiAoZGVzY3JpcHRvci5oZWFkZXJzKSB7XG4gICAgICAgICAgZm9yIChjb25zdCBrIGluIGRlc2NyaXB0b3IuaGVhZGVycykge1xuICAgICAgICAgICAgaWYgKGRlc2NyaXB0b3IuaGVhZGVycy5oYXNPd25Qcm9wZXJ0eShrKSkge1xuICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgIGhlYWRlcnMuc2V0KGssIGRlc2NyaXB0b3IuaGVhZGVyc1trXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBIZWFkZXIpIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IGsgaW4gcEhlYWRlcikge1xuICAgICAgICAgICAgaWYgKHBIZWFkZXIuaGFzT3duUHJvcGVydHkoaykpIHtcbiAgICAgICAgICAgICAgaGVhZGVycy5zZXQocEhlYWRlcltrXS5rZXksIGFyZ3NbcEhlYWRlcltrXS5wYXJhbWV0ZXJJbmRleF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zdCBmaW5hbFVybCA9IHVybFJlc29sdmUoIHJlc1VybCwgc2VsZltTeW1ib2xCYXNlVXJsXSgpKTtcbiAgICAgICAgbGV0IHJlcXVlc3Q6IElBeGlvc1JlcXVlc3RDb25maWcgfCBIdHRwUmVxdWVzdE9wdGlvbnMgPSBuZXcgSHR0cFJlcXVlc3RPcHRpb25zKGZpbmFsVXJsLCBtZXRob2QsIGJvZHksIGhlYWRlcnMsIHBhcmFtcyk7XG4gICAgICAgIGlmICh0aGlzW1N5bWJvbFJlcXVlc3RJbnRlcmNlcHRvcl0pIHtcbiAgICAgICAgICByZXF1ZXN0ID0gdGhpc1tTeW1ib2xSZXF1ZXN0SW50ZXJjZXB0b3JdKHJlcXVlc3QpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJlcXVlc3QgaW5zdGFuY2VvZiBIdHRwUmVxdWVzdE9wdGlvbnMpXG4gICAgICAgIHtcbiAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgcmVxdWVzdCA9IHJlcXVlc3QudG9WYWx1ZSgpIGFzIElBeGlvc1JlcXVlc3RDb25maWdcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG9sZFRyYW5zZm9ybVJlc3BvbnNlID0gcmVxdWVzdC50cmFuc2Zvcm1SZXNwb25zZTtcblxuICAgICAgICBsZXQgbmV3VHJhbnNmb3JtUmVzcG9ucyA9IGZ1bmN0aW9uIChkYXRhOiBhbnkpXG4gICAgICAgIHtcbiAgICAgICAgICBsZXQgcmV0ID0gb2xkRm4uY2FsbChzZWxmLCBkYXRhKTtcblxuICAgICAgICAgIGlmIChyZXQgPT0gbnVsbClcbiAgICAgICAgICB7XG4gICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gcmV0O1xuICAgICAgICB9O1xuXG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheShvbGRUcmFuc2Zvcm1SZXNwb25zZSkpXG4gICAgICAgIHtcbiAgICAgICAgICBpZiAoIW9sZFRyYW5zZm9ybVJlc3BvbnNlKVxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHJlcXVlc3QudHJhbnNmb3JtUmVzcG9uc2UgPSBbXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZVxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHJlcXVlc3QudHJhbnNmb3JtUmVzcG9uc2UgPSBbb2xkVHJhbnNmb3JtUmVzcG9uc2VdO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIChyZXF1ZXN0LnRyYW5zZm9ybVJlc3BvbnNlIGFzIGFueVtdKS5wdXNoKG5ld1RyYW5zZm9ybVJlc3BvbnMpO1xuXG4gICAgICAgIHJldHVybiBzZWxmLiRodHRwLnJlcXVlc3QocmVxdWVzdCk7XG4gICAgICB9O1xuICAgIH07XG4gIH07XG59XG5cbi8qKlxuICogR0VUIG1ldGhvZC5cbiAqIEBwYXJhbSB1cmwgICByZXNvdXJjZSBVUkwgb2YgdGhlIG1ldGhvZFxuICovXG5leHBvcnQgY29uc3QgR0VUID0gbWV0aG9kQnVpbGRlcihFbnVtUmVzdENsaWVudE1ldGFkYXRhLk1FVEhPRF9HRVQpO1xuXG4vKipcbiAqIFBPU1QgbWV0aG9kLlxuICogQHBhcmFtIHVybCAgIHJlc291cmNlIFVSTCBvZiB0aGUgbWV0aG9kXG4gKi9cbmV4cG9ydCBjb25zdCBQT1NUID0gbWV0aG9kQnVpbGRlcihFbnVtUmVzdENsaWVudE1ldGFkYXRhLk1FVEhPRF9QT1NUKTtcblxuLyoqXG4gKiBQVVQgbWV0aG9kLlxuICogQHBhcmFtIHVybCAgIHJlc291cmNlIFVSTCBvZiB0aGUgbWV0aG9kXG4gKi9cbmV4cG9ydCBjb25zdCBQVVQgPSBtZXRob2RCdWlsZGVyKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuTUVUSE9EX1BVVCk7XG5cbi8qKlxuICogUEFUQ0ggbWV0aG9kLlxuICogQHBhcmFtIHVybCAgIHJlc291cmNlIFVSTCBvZiB0aGUgbWV0aG9kXG4gKi9cbmV4cG9ydCBjb25zdCBQQVRDSCA9IG1ldGhvZEJ1aWxkZXIoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5NRVRIT0RfUEFUQ0gpO1xuXG4vKipcbiAqIERFTEVURSBtZXRob2QuXG4gKiBAcGFyYW0gdXJsICAgcmVzb3VyY2UgVVJMIG9mIHRoZSBtZXRob2RcbiAqL1xuZXhwb3J0IGNvbnN0IERFTEVURSA9IG1ldGhvZEJ1aWxkZXIoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5NRVRIT0RfREVMRVRFKTtcblxuLyoqXG4gKiBIRUFEIG1ldGhvZC5cbiAqIEBwYXJhbSB1cmwgICByZXNvdXJjZSBVUkwgb2YgdGhlIG1ldGhvZFxuICovXG5leHBvcnQgY29uc3QgSEVBRCA9IG1ldGhvZEJ1aWxkZXIoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5NRVRIT0RfSEVBRCk7XG4iXX0=